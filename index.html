<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Gesti√≥n</title>
    <style>
        /* --- ESTILOS VISUALES --- */
        :root {
            --primary: #2563eb;       /* Azul Empresas */
            --expense-color: #be123c; /* Rojo Gastos */
            --salary-color: #059669;  /* Verde Sueldos */
            --tax-color: #7c3aed;     /* Violeta Ingresos */
            --data-color: #475569;    /* Gris Datos */
            --galicia: #ea580c;       
            --frances: #0f172a;       
            --bg: #f1f5f9;
            --white: #ffffff;
            --border: #cbd5e1;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); margin: 0; padding: 10px; color: #0f172a; 
            -webkit-tap-highlight-color: transparent; padding-bottom: 80px;
        }
        
        .container { max-width: 1000px; margin: 0 auto; }

        /* --- NAVEGACI√ìN --- */
        .main-nav {
            display: flex; gap: 5px; background: #fff; padding: 5px;
            border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            margin-bottom: 15px; position: sticky; top: 0; z-index: 100; flex-wrap: wrap;
        }
        .main-nav button {
            flex: 1; padding: 10px 5px; border: none; background: transparent;
            font-size: 10px; font-weight: 800; cursor: pointer;
            border-radius: 8px; color: #94a3b8; transition: 0.2s;
            text-transform: uppercase; min-width: 60px;
        }
        .main-nav button.active-income { background: var(--primary); color: white; }
        .main-nav button.active-expense { background: var(--expense-color); color: white; }
        .main-nav button.active-salary { background: var(--salary-color); color: white; }
        .main-nav button.active-tax { background: var(--tax-color); color: white; }
        .main-nav button.active-data { background: var(--data-color); color: white; }

        /* --- SECCIONES --- */
        .macro-section { display: none; animation: fadeIn 0.3s; }
        .macro-section.active { display: block; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }

        /* --- UI COMPONENTES --- */
        .card { background: var(--white); padding: 15px; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid var(--border); }
        
        .tabs { display: flex; gap: 5px; background: #e2e8f0; padding: 4px; border-radius: 10px; overflow-x: auto; margin-bottom: 15px; }
        .tab-btn {
            flex: 1; padding: 10px; border: none; background: transparent; cursor: pointer;
            border-radius: 8px; font-weight: 600; color: #64748b; font-size: 12px; min-width: 80px; text-align: center;
        }
        .tab-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* INPUTS GENERICOS */
        input, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 16px; box-sizing: border-box; background: #fff; margin-bottom: 8px; }
        input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* INPUTS SUELDOS (TAMA√ëO REDUCIDO) */
        .salary-input { 
            width: 100%; 
            padding: 5px !important; 
            font-size: 13px !important; 
            font-weight: 700 !important; 
            color: #064e3b !important;
            background: #ecfdf5 !important;
            border: 1px solid #a7f3d0 !important;
            border-radius: 5px;
            text-align: right;
            margin: 0 !important;
        }
        .salary-input:focus {
            background: #fff !important;
            border-color: #059669 !important;
        }

        /* INPUTS GASTOS FIJOS (AUTO-SAVE) */
        .fix-expense-input {
            margin: 0 !important; 
            text-align: right; 
            font-weight: bold; 
            color: #be123c; 
            font-size: 14px;
            transition: background 0.3s;
        }
        .expense-item-div {
            padding: 8px; border-radius: 8px; transition: 0.3s;
        }

        /* BOTONES */
        .btn-primary { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 700; width: 100%; cursor: pointer; font-size: 16px; }
        .btn-expense { background: var(--expense-color); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 700; width: 100%; cursor: pointer; font-size: 16px; }
        .btn-data { background: var(--data-color); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 700; width: 100%; cursor: pointer; font-size: 16px; }
        .btn-sm { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; border: none; cursor: pointer; }
        .btn-success { background: #16a34a; color: white; }
        .btn-danger { background: #fee2e2; color: #dc2626; }
        
        /* FILTROS DE BANCO */
        .bank-filters { display: flex; gap: 5px; margin-bottom: 10px; }
        .bank-filter-btn { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: white; font-size: 11px; font-weight: bold; cursor: pointer; }
        .bank-filter-btn.active { background: #334155; color: white; border-color: #334155; }

        /* LISTAS */
        .companies-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .company-btn {
            background: var(--white); border: 2px solid var(--border); color: #334155;
            padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 700; text-align: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80px;
        }
        
        /* TABLAS */
        .table-wrapper { overflow-x: auto; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; min-width: 100%; }
        th, td { padding: 8px 5px; text-align: left; border-bottom: 1px solid var(--border); font-size: 12px; vertical-align: middle; }
        th { font-size: 10px; text-transform: uppercase; color: #64748b; font-weight: 700; background: #f8fafc; }
        
        /* TAGS */
        .tag { font-size: 9px; padding: 2px 4px; border-radius: 4px; color: white; font-weight: bold; text-transform: uppercase; margin-right: 2px; display: inline-block; }
        .bg-aud { background: #d97706; }
        .bg-fac { background: #2563eb; }
        .bg-gal { background: var(--galicia); }
        .bg-fra { background: var(--frances); }
        
        /* TOTALES */
        .total-box { padding: 15px; border-radius: 12px; text-align: center; color: white; margin-bottom: 15px; }
        .bg-blue { background: var(--primary); }
        .bg-red { background: var(--expense-color); }
        .total-amount { font-size: 26px; font-weight: 800; }

        /* TARJETAS DE RESUMEN DE INGRESOS */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .summary-card { background: white; padding: 10px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .summary-card h4 { margin: 0 0 10px 0; color: var(--tax-color); text-transform: uppercase; font-size: 11px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; }
        .summary-row { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; color: #64748b; }
        .summary-row.total { font-weight: bold; color: #0f172a; font-size: 13px; margin-top: 8px; border-top: 1px dashed #e2e8f0; padding-top: 5px; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: flex-end; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; padding: 20px; max-height: 90vh; overflow-y: auto; }
        @media(min-width: 600px) { .modal { align-items: center; } .modal-content { border-radius: 16px; width: 90%; } }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    
    <nav class="main-nav">
        <button id="nav-income" class="active-income" onclick="showMacroSection('income')">üè¢ Empresas</button>
        <button id="nav-expense" onclick="showMacroSection('expense')">üí∏ Gastos</button>
        <button id="nav-salary" onclick="showMacroSection('salary')">üíµ Sueldos</button>
        <button id="nav-tax" onclick="showMacroSection('tax')">üìä Ingresos</button>
        <button id="nav-data" onclick="showMacroSection('data')">üíæ Datos</button>
    </nav>

    <div id="macro-income" class="macro-section active">
        
        <div class="tabs">
            <button id="tab1" class="tab-btn active" onclick="switchIncomeTab('companies')">Empresas</button>
            <button id="tab2" class="tab-btn" onclick="switchIncomeTab('pending')">‚ö†Ô∏è Deudores</button>
            <button id="tab3" class="tab-btn" onclick="switchIncomeTab('billing')">üìÑ Facturado</button>
            <button id="tab4" class="tab-btn" onclick="switchIncomeTab('collected')">üí∞ Cobrado</button>
            <button id="tab5" class="tab-btn" onclick="switchIncomeTab('filter')">üîç Ficha</button>
        </div>

        <div id="view-companies" class="view-section active">
            <div class="card" style="padding:10px;">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="newCompanyName" placeholder="Nueva Empresa..." style="margin:0;">
                    <button class="btn-primary" style="width: auto;" onclick="addCompany()">+</button>
                </div>
            </div>
            <div id="companiesList" class="companies-grid"></div>
        </div>

        <div id="view-pending" class="view-section">
            <div class="total-box" style="background: #ef4444;">
                <div style="font-size:12px; opacity:0.9;">TOTAL POR COBRAR</div>
                <div class="total-amount" id="globalPendingTotal">$0</div>
            </div>
            <div id="pendingList"></div>
        </div>

        <div id="view-billing" class="view-section">
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-size:14px;">Mes Emisi√≥n:</h3>
                <input type="month" id="billingMonthSelector" onchange="loadBillingView()" style="width:auto; margin:0;">
            </div>
            <div id="billingStatusContainer"></div>
            <div id="billingResults"></div>
        </div>

        <div id="view-collected" class="view-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0; font-size:14px;">Mes Cobro:</h3>
                    <input type="month" id="collectedMonthSelector" onchange="loadCollectedView()" style="width:auto; margin:0;">
                </div>
                <div class="bank-filters">
                    <button class="bank-filter-btn active" onclick="filterBank('all', this)">VER TODO</button>
                    <button class="bank-filter-btn" onclick="filterBank('galicia', this)">GALICIA</button>
                    <button class="bank-filter-btn" onclick="filterBank('frances', this)">FRANC√âS</button>
                </div>
            </div>
            <div id="collectedResults"></div>
        </div>

        <div id="view-filter" class="view-section">
            <div class="card">
                <h3 style="margin:0 0 10px 0; font-size:14px; color:#64748b;">Ficha Anual por Empresa:</h3>
                <select id="companyFilterSelect" onchange="loadCompanySpecificStats()">
                    <option value="">-- Seleccionar --</option>
                </select>
                
                <div style="margin-top:10px;">
                    <select id="filterYear" onchange="loadCompanySpecificStats()" style="width:auto;">
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
            </div>
            <div id="companyFilterResults"></div>
        </div>
    </div>

    <div id="macro-expense" class="macro-section">
        <div class="card" style="border: 1px solid var(--expense-color);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:var(--expense-color);">Gastos</h3>
                <input type="month" id="expenseMonth" onchange="loadExpensesView()" style="width:auto; margin:0;">
            </div>

            <div id="fixedExpensesGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px;"></div>
            
            <p style="text-align:center; font-size:11px; color:#64748b; margin-top:0;">* Se guarda autom√°ticamente al cambiar el valor.</p>
            
            <hr style="margin: 20px 0; border:0; border-top:1px dashed #ccc;">

            <div style="background:#f1f5f9; padding:10px; border-radius:8px;">
                <h4 style="margin:0 0 10px 0; font-size:12px; color:#64748b;">Gasto Extra</h4>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="extraName" placeholder="Ej: Farmacia" style="margin:0;">
                    <input type="number" id="extraAmount" placeholder="$" style="width:80px; margin:0;">
                </div>
                <button class="btn-sm" style="background:#64748b; color:white; width:100%; margin-top:5px;" onclick="addExtraExpense()">+ Agregar</button>
            </div>
        </div>
        <div id="expensesResults"></div>
    </div>

    <div id="macro-salary" class="macro-section">
        <div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
             <h3 style="margin:0; color:var(--salary-color)">Planilla Sueldos</h3>
             <select id="salaryYear" onchange="loadSalaryView()" style="width:auto; margin:0; font-weight:bold;">
                 <option value="2025">2025</option>
                 <option value="2026">2026</option>
                 <option value="2027">2027</option>
             </select>
        </div>

        <div class="card">
            <div class="table-wrapper">
                <table class="tax-table">
                    <thead>
                        <tr>
                            <th style="width:30px">Mes</th>
                            <th style="min-width:60px;">Sueldo</th>
                            <th style="min-width:60px;">Present.</th>
                            <th style="color:var(--salary-color)">Tot Yani</th>
                            <th style="min-width:60px;">Tot Mauro</th>
                            <th>Tot General</th>
                        </tr>
                    </thead>
                    <tbody id="salaryTableBody"></tbody>
                </table>
            </div>
        </div>
        <p style="text-align:center; font-size:11px; color:#64748b;">* Actualiza autom√°ticamente la secci√≥n INGRESOS.</p>
    </div>

    <div id="macro-tax" class="macro-section">
        <div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
             <h3 style="margin:0; color:var(--tax-color)">Ingresos / AFIP</h3>
             <select id="taxYear" onchange="loadTaxView()" style="width:auto; margin:0; font-weight:bold;">
                 <option value="2025">2025</option>
                 <option value="2026">2026</option>
             </select>
        </div>

        <div class="summary-grid">
            <div class="summary-card">
                <h4>üë§ Yanina</h4>
                <div class="summary-row"><span>1¬∞ Sem:</span> <span id="sumY1">-</span></div>
                <div class="summary-row"><span>2¬∞ Sem:</span> <span id="sumY2">-</span></div>
                <div class="summary-row total"><span>Anual:</span> <span id="sumYT">-</span></div>
            </div>
            <div class="summary-card">
                <h4>üë§ Mauro</h4>
                <div class="summary-row"><span>1¬∞ Sem:</span> <span id="sumM1">-</span></div>
                <div class="summary-row"><span>2¬∞ Sem:</span> <span id="sumM2">-</span></div>
                <div class="summary-row total"><span>Anual:</span> <span id="sumMT">-</span></div>
            </div>
            <div class="summary-card" style="border-color: #2563eb; background:#eff6ff;">
                <h4 style="color:#2563eb;">üåé TOTAL GENERAL</h4>
                <div class="summary-row"><span>1¬∞ Sem:</span> <span id="sumG1" style="font-weight:bold;">-</span></div>
                <div class="summary-row"><span>2¬∞ Sem:</span> <span id="sumG2" style="font-weight:bold;">-</span></div>
                <div class="summary-row total" style="color:#2563eb; font-size:15px;"><span>ANUAL:</span> <span id="sumGT">-</span></div>
            </div>
        </div>

        <div class="card">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Mes</th>
                            <th>Yanina</th>
                            <th>Mauro</th>
                            <th>TOTAL</th>
                            <th>AFIP Yani</th>
                            <th>AFIP Mauro</th>
                        </tr>
                    </thead>
                    <tbody id="taxTableBody"></tbody>
                </table>
            </div>
        </div>
        <p style="text-align:center; font-size:11px; color:#64748b;">* Los montos provienen de la secci√≥n SUELDOS.</p>
    </div>

    <div id="macro-data" class="macro-section">
        <h3 style="color:var(--data-color); margin-bottom:10px;">Gesti√≥n de Datos</h3>
        
        <div class="card">
            <h4 style="margin-top:0;">üì§ Pasar datos a otro dispositivo</h4>
            <p style="font-size:13px; color:#64748b;">
                1. Hac√© clic en <b>"Descargar Copia"</b>.<br>
                2. Se bajar√° un archivo <code>datos_sistema.json</code>.<br>
                3. Envi√° ese archivo por WhatsApp o Email a tu otro dispositivo (celular/PC).
            </p>
            <button class="btn-data" onclick="exportData()">‚¨áÔ∏è Descargar Copia</button>
        </div>

        <div class="card">
            <h4 style="margin-top:0;">üì• Cargar datos desde archivo</h4>
            <p style="font-size:13px; color:#64748b;">
                1. Abr√≠ esta App en el otro dispositivo.<br>
                2. Seleccion√° el archivo que te enviaste.<br>
                3. Hac√© clic en <b>"Restaurar"</b> para cargar toda la informaci√≥n.
            </p>
            <input type="file" id="importFile" accept=".json" style="margin-bottom:10px;">
            <button class="btn-primary" onclick="importData()">‚¨ÜÔ∏è Restaurar Copia</button>
        </div>
        
        <p style="text-align:center; font-size:11px; color:#ef4444; margin-top:20px;">
            ‚ö†Ô∏è Importante: Al restaurar una copia, se borrar√°n los datos actuales de este dispositivo y se reemplazar√°n por los del archivo.
        </p>
    </div>

</div>

<div id="companyModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 id="modalTitle" style="margin:0; color:var(--primary);">Empresa</h2>
            <button onclick="closeModal()" style="background:none; border:none; font-size:24px;">&times;</button>
        </div>

        <div class="card" style="background: #f8fafc; padding:15px; border:1px solid #cbd5e1; box-shadow:none;">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="entryType">
                    <option value="factura">üìÑ Factura</option>
                    <option value="auditoria">üõ°Ô∏è Auditor√≠a</option>
                </select>
                <select id="bankSelect">
                    <option value="galicia">üçä Galicia</option>
                    <option value="frances">üîµ Franc√©s</option>
                </select>
            </div>

            <div style="display:flex; gap:10px;">
                <input type="text" id="invNum" placeholder="N¬∞ Factura">
                <input type="number" id="amount" placeholder="$ Monto">
            </div>
            
            <input type="text" id="entryDetail" placeholder="Detalle (Opcional)">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label style="font-size:10px; font-weight:bold;">EMISI√ìN</label>
                    <input type="date" id="dateBill">
                </div>
                <div>
                    <label style="font-size:10px; font-weight:bold;">COBRO</label>
                    <input type="date" id="datePay">
                </div>
            </div>

            <div style="display:flex; align-items:center; gap:10px; margin-top:5px; background:#fff7ed; padding:8px; border-radius:6px; border:1px solid #ffedd5;">
                <input type="checkbox" id="checkPending" onchange="toggleDateInput()" style="width:20px; margin:0;">
                <label for="checkPending" style="font-size:12px; font-weight:bold; color:#c2410c;">PENDIENTE (No cobrado)</label>
            </div>
            
            <button class="btn-primary" onclick="saveCompanyEntry()" style="margin-top:15px;">Guardar</button>
        </div>

        <h3>Historial</h3>
        <div class="table-wrapper">
            <table id="companyHistoryTable">
                <thead><tr><th>Detalle</th><th>Fechas</th><th>Monto</th><th></th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- DATOS ---
    let companies = JSON.parse(localStorage.getItem('sys_companies_v5')) || {};
    let expenses = JSON.parse(localStorage.getItem('sys_expenses_v5')) || {};
    let salaries = JSON.parse(localStorage.getItem('sys_salaries_v2')) || {}; 
    
    let currentCompany = null;
    let currentBankFilter = 'all';

    const fixedExpenseList = [
        "AMEX", "TARJ FRANCES", "FRANCES MASTER", "TARJ GALICIA", "TARJ ICBC", 
        "TARJ HIPOTECARIO", "TARJ BANCO NACION", "SERV-LUZ", "GAS", "EXPENSAS", 
        "NAFTA", "SUPERMERCADO", "MUNICIPAL", "ARBA CASA Y PATENTE", 
        "IIGG YANINA", "IIGG MAURO", "MONOTRIBUTO", "COLEGIO LUCCA", 
        "COLEGIO EMMA", "HONORARIOS", "TELEFONOS", "EXTRAS"
    ];

    // --- UTILS ---
    const formatMoney = (val) => '$' + val.toLocaleString('es-AR');
    const formatDate = (s) => { if(!s) return '-'; const [y,m,d]=s.split('-'); return `${d}/${m}`; };
    function saveAll() {
        localStorage.setItem('sys_companies_v5', JSON.stringify(companies));
        localStorage.setItem('sys_expenses_v5', JSON.stringify(expenses));
        localStorage.setItem('sys_salaries_v2', JSON.stringify(salaries));
    }

    function showMacroSection(sec) {
        document.querySelectorAll('.macro-section').forEach(el => el.classList.remove('active'));
        document.getElementById('macro-' + sec).classList.add('active');
        
        document.querySelectorAll('.main-nav button').forEach(b => b.className = '');
        document.getElementById('nav-' + sec).classList.add('active-' + sec);

        if(sec === 'expense') loadExpensesView();
        if(sec === 'income') refreshIncomeViews();
        if(sec === 'salary') loadSalaryView();
        if(sec === 'tax') loadTaxView();
    }

    // ==========================================
    // SECCI√ìN 1: EMPRESAS
    // ==========================================

    function addCompany() {
        const name = document.getElementById('newCompanyName').value.trim();
        if(!name) return;
        if(companies[name]) return alert('Ya existe');
        companies[name] = [];
        document.getElementById('newCompanyName').value = '';
        saveAll();
        renderCompanies();
        populateCompanyFilter();
    }

    function renderCompanies() {
        const container = document.getElementById('companiesList');
        container.innerHTML = '';
        Object.keys(companies).sort().forEach(name => {
            const btn = document.createElement('div');
            btn.className = 'company-btn';
            const pend = companies[name].filter(e => e.datePay === "").length;
            const badge = pend > 0 ? `<div style="background:#fee2e2; color:#ef4444; font-size:10px; padding:2px 6px; border-radius:10px; margin-top:5px;">‚ö†Ô∏è ${pend} Pend</div>` : '';
            btn.innerHTML = `<span style="font-size:14px;">${name}</span> ${badge}`;
            btn.onclick = () => openCompanyModal(name);
            container.appendChild(btn);
        });
        populateCompanyFilter();
    }

    // Modal
    function openCompanyModal(name) {
        currentCompany = name;
        document.getElementById('modalTitle').textContent = name;
        document.getElementById('companyModal').style.display = 'flex';
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dateBill').value = today;
        document.getElementById('datePay').value = today;
        document.getElementById('checkPending').checked = false;
        document.getElementById('entryDetail').value = '';
        toggleDateInput();
        renderCompanyHistory();
    }
    function closeModal() { document.getElementById('companyModal').style.display = 'none'; currentCompany = null; }
    function toggleDateInput() {
        const chk = document.getElementById('checkPending');
        const inp = document.getElementById('datePay');
        inp.disabled = chk.checked;
        inp.style.background = chk.checked ? '#e2e8f0' : '#fff';
        if(chk.checked) inp.value = ''; else inp.value = new Date().toISOString().split('T')[0];
    }

    function saveCompanyEntry() {
        const type = document.getElementById('entryType').value;
        const bank = document.getElementById('bankSelect').value;
        const num = document.getElementById('invNum').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const dateBill = document.getElementById('dateBill').value;
        const detail = document.getElementById('entryDetail').value;
        let datePay = document.getElementById('checkPending').checked ? "" : document.getElementById('datePay').value;

        if(!num || isNaN(amount) || !dateBill) return alert('Faltan datos obligatorios');
        
        // VALIDACI√ìN DE FECHA
        if(datePay && dateBill > datePay) {
            return alert('Error: La fecha de Emisi√≥n no puede ser posterior a la fecha de Cobro.');
        }

        companies[currentCompany].push({ id: Date.now(), type, bank, num, amount, dateBill, datePay, detail });
        
        document.getElementById('invNum').value = '';
        document.getElementById('amount').value = '';
        document.getElementById('entryDetail').value = '';
        saveAll();
        renderCompanyHistory();
    }

    function renderCompanyHistory() {
        const tbody = document.querySelector('#companyHistoryTable tbody');
        tbody.innerHTML = '';
        const list = companies[currentCompany].sort((a,b) => new Date(b.dateBill) - new Date(a.dateBill));
        
        list.forEach(e => {
            const isPend = e.datePay === "";
            // TAGS
            const typeTag = e.type === 'auditoria' ? '<span class="tag bg-aud">AUD</span>' : '<span class="tag bg-fac">FAC</span>';
            const bankTag = e.bank === 'galicia' ? '<span class="tag bg-gal">GAL</span>' : '<span class="tag bg-fra">FRA</span>';
            const det = e.detail ? `<span style="font-size:11px; font-style:italic; color:#666; display:block;">${e.detail}</span>` : '';

            const btnAction = isPend 
                ? `<button class="btn-sm btn-success" onclick="markPaid('${currentCompany}',${e.id})">$</button>` 
                : '';

            tbody.innerHTML += `
                <tr>
                    <td>${typeTag} ${bankTag} <b>${e.num}</b> ${det}</td>
                    <td>E:${formatDate(e.dateBill)}<br>C:${formatDate(e.datePay)}</td>
                    <td><b>${formatMoney(e.amount)}</b></td>
                    <td align="right" style="white-space:nowrap;">
                        ${btnAction}
                        <button class="btn-sm btn-danger" onclick="delEntry('${currentCompany}',${e.id})">√ó</button>
                    </td>
                </tr>
            `;
        });
    }

    // --- VISTAS INGRESOS ---
    function loadPendingView() {
        const div = document.getElementById('pendingList');
        div.innerHTML = '';
        let total = 0;
        
        Object.keys(companies).forEach(name => {
            const list = companies[name].filter(e => e.datePay === "");
            if(list.length > 0) {
                const sub = list.reduce((s,e)=>s+e.amount,0);
                total += sub;
                let rows = list.map(e => {
                    const tTag = e.type==='auditoria'?'<span class="tag bg-aud">AUD</span>':'<span class="tag bg-fac">FAC</span>';
                    const bTag = e.bank==='galicia'?'<span class="tag bg-gal">GAL</span>':'<span class="tag bg-fra">FRA</span>';
                    return `
                    <tr>
                        <td>${tTag} ${bTag} <b>${e.num}</b></td>
                        <td>${formatDate(e.dateBill)}</td>
                        <td>${formatMoney(e.amount)}</td>
                        <td align="right"><button class="btn-sm btn-success" onclick="markPaid('${name}',${e.id})">Cobrar</button></td>
                    </tr>`;
                }).join('');
                div.innerHTML += `<div class="card"><h4>${name} <span style="float:right; color:#dc2626">${formatMoney(sub)}</span></h4><table>${rows}</table></div>`;
            }
        });
        document.getElementById('globalPendingTotal').innerText = formatMoney(total);
        if(total === 0) div.innerHTML = '<p style="text-align:center; color:#999">Todo al d√≠a.</p>';
    }

    function loadBillingView() {
        const month = document.getElementById('billingMonthSelector').value;
        const divResults = document.getElementById('billingResults');
        const divStatus = document.getElementById('billingStatusContainer');
        divResults.innerHTML = ''; divStatus.innerHTML = '';
        if(!month) return;

        let totalBilled = 0;
        let totalPendingInMonth = 0;

        Object.keys(companies).forEach(name => {
            const list = companies[name].filter(e => e.dateBill.startsWith(month));
            if(list.length > 0) {
                let sub = list.reduce((s,e)=>s+e.amount,0);
                totalBilled += sub;
                
                let rows = list.map(e => {
                    const isPaid = e.datePay !== "";
                    if(!isPaid) totalPendingInMonth += e.amount;
                    const status = isPaid ? '<span style="color:green">‚úî</span>' : '<span style="color:red">‚è≥</span>';
                    const tTag = e.type==='auditoria'?'<span class="tag bg-aud">AUD</span>':'<span class="tag bg-fac">FAC</span>';
                    const bTag = e.bank==='galicia'?'<span class="tag bg-gal">GAL</span>':'<span class="tag bg-fra">FRA</span>';
                    return `<tr><td>${tTag} ${bTag} <b>${e.num}</b></td><td>${status}</td><td align="right"><b>${formatMoney(e.amount)}</b></td></tr>`;
                }).join('');
                divResults.innerHTML += `<div class="card"><h4>${name}</h4><table>${rows}</table></div>`;
            }
        });

        if(totalBilled > 0) {
            divStatus.innerHTML = (totalPendingInMonth === 0) 
                ? `<div style="background:#dcfce7; color:#166534; padding:15px; border-radius:12px; text-align:center; font-weight:bold; margin-bottom:15px; border:2px solid #bbf7d0;">‚ú® ¬°FELICITACIONES! ‚ú®<br>Todo cobrado.</div>`
                : `<div style="background:#fee2e2; color:#dc2626; padding:15px; border-radius:12px; text-align:center; font-weight:bold; margin-bottom:15px; border:2px solid #fecaca;">‚ö†Ô∏è FALTA COBRAR: ${formatMoney(totalPendingInMonth)}</div>`;
            divResults.insertAdjacentHTML('afterbegin', `<div class="total-box bg-blue"><div style="font-size:12px;">TOTAL FACTURADO</div><div class="total-amount">${formatMoney(totalBilled)}</div></div>`);
        } else {
            divResults.innerHTML = '<p style="text-align:center; padding:20px;">Sin facturaci√≥n.</p>';
        }
    }

    function loadCollectedView() {
        const month = document.getElementById('collectedMonthSelector').value;
        const div = document.getElementById('collectedResults');
        div.innerHTML = '';
        if(!month) return;

        let total = 0;
        Object.keys(companies).forEach(name => {
            const list = companies[name].filter(e => {
                return (e.datePay && e.datePay.startsWith(month)) && (currentBankFilter === 'all' || e.bank === currentBankFilter);
            });

            if(list.length > 0) {
                let sub = list.reduce((s,e)=>s+e.amount,0);
                total += sub;
                let rows = list.map(e => {
                     const bTag = e.bank==='galicia'?'<span class="tag bg-gal">GAL</span>':'<span class="tag bg-fra">FRA</span>';
                     const tTag = e.type==='auditoria'?'<span class="tag bg-aud">AUD</span>':'<span class="tag bg-fac">FAC</span>';
                     return `<tr><td>${tTag} ${bTag} <b>${e.num}</b></td><td>${formatDate(e.datePay)}</td><td align="right"><b>${formatMoney(e.amount)}</b></td></tr>`;
                }).join('');
                div.innerHTML += `<div class="card"><h4>${name}</h4><table>${rows}</table></div>`;
            }
        });

        if(total > 0) div.insertAdjacentHTML('afterbegin', `<div class="total-box" style="background:#16a34a"><div style="font-size:12px;">TOTAL COBRADO</div><div class="total-amount">${formatMoney(total)}</div></div>`);
        else div.innerHTML = '<p style="text-align:center; padding:20px;">Sin cobros.</p>';
    }

    function filterBank(filter, btn) {
        currentBankFilter = filter;
        document.querySelectorAll('.bank-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadCollectedView();
    }

    // --- 1.5 FICHA EMPRESA (FILTRO) ---
    function populateCompanyFilter() {
        const sel = document.getElementById('companyFilterSelect');
        sel.innerHTML = '<option value="">-- Elige una empresa --</option>';
        Object.keys(companies).sort().forEach(c => {
            sel.innerHTML += `<option value="${c}">${c}</option>`;
        });
    }

    function loadCompanySpecificStats() {
        const comp = document.getElementById('companyFilterSelect').value;
        const year = document.getElementById('filterYear').value;
        const div = document.getElementById('companyFilterResults');
        div.innerHTML = '';
        
        if(!comp) return;

        // Estructura de meses
        let html = '<div class="card"><table style="font-size:12px;"><thead><tr><th>Mes</th><th>Cob. FAC</th><th>Cob. AUD</th><th>TOTAL</th></tr></thead><tbody>';
        let totalFac = 0;
        let totalAud = 0;
        let totalAll = 0;

        for(let i=1; i<=12; i++) {
            const mStr = i.toString().padStart(2, '0');
            const key = `${year}-${mStr}`;
            
            // Filter items paid in this month/year
            const paidItems = companies[comp].filter(e => e.datePay && e.datePay.startsWith(key));

            // Sum Facturas
            const cobFactura = paidItems.filter(e => e.type === 'factura').reduce((s,e)=>s+e.amount, 0);

            // Sum Auditorias
            const cobAuditoria = paidItems.filter(e => e.type === 'auditoria').reduce((s,e)=>s+e.amount, 0);

            const totalMonth = cobFactura + cobAuditoria;

            totalFac += cobFactura;
            totalAud += cobAuditoria;
            totalAll += totalMonth;
            
            if(totalMonth > 0) {
                html += `<tr>
                    <td><b>${mStr}</b></td>
                    <td style="color:${cobFactura>0?'#2563eb':'#ccc'}">${formatMoney(cobFactura)}</td>
                    <td style="color:${cobAuditoria>0?'#d97706':'#ccc'}">${formatMoney(cobAuditoria)}</td>
                    <td style="font-weight:bold;">${formatMoney(totalMonth)}</td>
                </tr>`;
            }
        }
        
        html += `<tr style="background:#f1f5f9; border-top:2px solid #cbd5e1;">
                    <td><b>ANUAL</b></td>
                    <td style="color:#2563eb"><b>${formatMoney(totalFac)}</b></td>
                    <td style="color:#d97706"><b>${formatMoney(totalAud)}</b></td>
                    <td><b>${formatMoney(totalAll)}</b></td>
                 </tr></tbody></table></div>`;
        
        div.innerHTML = html;
    }


    // ==========================================
    // SECCI√ìN 2: GASTOS
    // ==========================================

    function loadExpensesView() {
        const month = document.getElementById('expenseMonth').value;
        const grid = document.getElementById('fixedExpensesGrid');
        const divRes = document.getElementById('expensesResults');
        
        if(!expenses[month]) expenses[month] = [];
        
        grid.innerHTML = '';
        fixedExpenseList.forEach(name => {
            const existing = expenses[month].find(e => e.name === name);
            const val = existing ? existing.amount : '';
            const bg = (!val || val == 0) ? '#fef2f2; border:1px solid #fecaca;' : '#f8fafc; border:1px solid #e2e8f0;';
            
            // Usamos onchange para auto-guardar
            grid.innerHTML += `
                <div class="expense-item-div" style="background:${bg}">
                    <label style="display:block; font-size:10px; font-weight:700; color:#475569; margin-bottom:3px; height:15px; overflow:hidden;">${name}</label>
                    <input type="number" class="fix-expense-input" id="fix_${name.replace(/\s/g,'')}" placeholder="0" value="${val}" onchange="autoSaveFixed('${name}')">
                </div>
            `;
        });
        
        updateExpenseTotalDisplay();
    }

    function autoSaveFixed(name) {
        const month = document.getElementById('expenseMonth').value;
        const inputId = "fix_" + name.replace(/\s/g,'');
        const inputEl = document.getElementById(inputId);
        const val = parseFloat(inputEl.value);

        if(!expenses[month]) expenses[month] = [];

        // Encontrar indice
        const index = expenses[month].findIndex(e => e.name === name);

        if(!isNaN(val) && val > 0) {
            if(index >= 0) expenses[month][index].amount = val;
            else expenses[month].push({ id: Date.now(), name: name, amount: val });
            
            // Actualizar estilo visual del padre
            inputEl.parentElement.style.background = '#f8fafc';
            inputEl.parentElement.style.borderColor = '#e2e8f0';

        } else if (index >= 0) {
            // Borrar si vacio
            expenses[month].splice(index, 1);
            
            // Actualizar estilo visual del padre
            inputEl.parentElement.style.background = '#fef2f2';
            inputEl.parentElement.style.borderColor = '#fecaca';
        }
        
        saveAll();
        updateExpenseTotalDisplay();
    }

    function updateExpenseTotalDisplay() {
        const month = document.getElementById('expenseMonth').value;
        const divRes = document.getElementById('expensesResults');
        const list = expenses[month] || [];
        const total = list.reduce((s,e) => s+e.amount, 0);

        // Solo mostramos el total abajo y la lista si hay extras
        let extraList = list.filter(e => !fixedExpenseList.includes(e.name));
        
        let extraHtml = '';
        if(extraList.length > 0) {
            let rows = extraList.sort((a,b)=>b.amount - a.amount).map(e => `
                <tr>
                    <td>${e.name}</td>
                    <td align="right"><b>${formatMoney(e.amount)}</b></td>
                    <td style="width:20px;"><button class="btn-sm btn-danger" onclick="delExpense('${month}',${e.id})">√ó</button></td>
                </tr>
            `).join('');
            extraHtml = `<div class="card" style="margin-top:10px;"><h5>Extras Cargados</h5><table>${rows}</table></div>`;
        }

        divRes.innerHTML = `
            <div class="total-box bg-red" style="margin-top:20px;">
                <div style="font-size:12px;">TOTAL GASTOS</div>
                <div class="total-amount">${formatMoney(total)}</div>
            </div>
            ${extraHtml}
        `;
    }

    function addExtraExpense() {
        const month = document.getElementById('expenseMonth').value;
        const name = document.getElementById('extraName').value.trim();
        const amount = parseFloat(document.getElementById('extraAmount').value);
        if(!name || isNaN(amount)) return alert('Error en datos');
        if(!expenses[month]) expenses[month] = [];
        expenses[month].push({ id: Date.now(), name: name, amount: amount });
        document.getElementById('extraName').value = '';
        document.getElementById('extraAmount').value = '';
        saveAll();
        loadExpensesView();
    }
    
    function delExpense(m, id) { 
        if(confirm('¬øBorrar?')) { 
            expenses[m] = expenses[m].filter(e => e.id !== id); 
            saveAll(); 
            loadExpensesView(); 
        } 
    }

    // ==========================================
    // SECCI√ìN 3: SUELDOS
    // ==========================================
    
    function loadSalaryView() {
        const year = document.getElementById('salaryYear').value;
        const tbody = document.getElementById('salaryTableBody');
        tbody.innerHTML = '';

        for(let i=1; i<=12; i++) {
            const mStr = i.toString().padStart(2, '0');
            const monthKey = `${year}-${mStr}`;
            
            const data = salaries[monthKey] || { sueldo:0, pres:0, mauro:0, afip_yani:"", afip_mauro:"" };
            
            const totalYani = (data.sueldo || 0) + (data.pres || 0);
            const totalGen = totalYani + (data.mauro || 0);

            const row = `
                <tr>
                    <td style="font-weight:bold;">${mStr}</td>
                    <td><input type="number" class="salary-input" value="${data.sueldo||''}" onchange="saveSalary('${monthKey}', 'sueldo', this.value)" placeholder="$"></td>
                    <td><input type="number" class="salary-input" value="${data.pres||''}" onchange="saveSalary('${monthKey}', 'pres', this.value)" placeholder="$"></td>
                    <td style="font-weight:bold; color:var(--salary-color); font-size:13px;">${formatMoney(totalYani)}</td>
                    <td><input type="number" class="salary-input" value="${data.mauro||''}" onchange="saveSalary('${monthKey}', 'mauro', this.value)" placeholder="$"></td>
                    <td style="font-weight:bold; font-size:13px;">${formatMoney(totalGen)}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        }
    }

    function saveSalary(monthKey, field, val) {
        if(!salaries[monthKey]) salaries[monthKey] = { sueldo:0, pres:0, mauro:0, afip_yani:"", afip_mauro:"" };
        salaries[monthKey][field] = parseFloat(val) || 0;
        saveAll();
        loadSalaryView(); 
    }

    // ==========================================
    // SECCI√ìN 4: INGRESOS / IMPUESTOS
    // ==========================================

    function loadTaxView() {
        const year = document.getElementById('taxYear').value;
        const tbody = document.getElementById('taxTableBody');
        tbody.innerHTML = '';
        
        // Accumulators for Summary
        let sumY1=0, sumY2=0, sumM1=0, sumM2=0;

        for(let i=1; i<=12; i++) {
            const mStr = i.toString().padStart(2, '0');
            const monthKey = `${year}-${mStr}`;
            
            // DATA FROM SUELDOS
            const data = salaries[monthKey] || { sueldo:0, pres:0, mauro:0, afip_yani:"", afip_mauro:"" };
            
            const totalYani = (data.sueldo || 0) + (data.pres || 0);
            const totalMauro = (data.mauro || 0);
            const totalGen = totalYani + totalMauro;
            
            // Summary Calc
            if(i <= 6) { sumY1 += totalYani; sumM1 += totalMauro; }
            else { sumY2 += totalYani; sumM2 += totalMauro; }

            const row = `
                <tr>
                    <td style="font-weight:bold;">${mStr}</td>
                    <td>${formatMoney(totalYani)}</td>
                    <td>${formatMoney(totalMauro)}</td>
                    <td style="font-weight:bold; color:#2563eb;">${formatMoney(totalGen)}</td>
                    <td><input type="text" value="${data.afip_yani || ''}" onchange="saveAfip('${monthKey}', 'afip_yani', this.value)" placeholder="AFIP Y" style="width:60px; margin:0; font-size:11px;"></td>
                    <td><input type="text" value="${data.afip_mauro || ''}" onchange="saveAfip('${monthKey}', 'afip_mauro', this.value)" placeholder="AFIP M" style="width:60px; margin:0; font-size:11px;"></td>
                </tr>
            `;
            tbody.innerHTML += row;
        }

        // Totales Generales
        const sumG1 = sumY1 + sumM1;
        const sumG2 = sumY2 + sumM2;
        const sumGT = sumG1 + sumG2;

        // Update Summary Cards
        document.getElementById('sumY1').innerText = formatMoney(sumY1);
        document.getElementById('sumY2').innerText = formatMoney(sumY2);
        document.getElementById('sumYT').innerText = formatMoney(sumY1 + sumY2);
        
        document.getElementById('sumM1').innerText = formatMoney(sumM1);
        document.getElementById('sumM2').innerText = formatMoney(sumM2);
        document.getElementById('sumMT').innerText = formatMoney(sumM1 + sumM2);

        document.getElementById('sumG1').innerText = formatMoney(sumG1);
        document.getElementById('sumG2').innerText = formatMoney(sumG2);
        document.getElementById('sumGT').innerText = formatMoney(sumGT);
    }

    function saveAfip(monthKey, field, val) {
        if(!salaries[monthKey]) salaries[monthKey] = { sueldo:0, pres:0, mauro:0, afip_yani:"", afip_mauro:"" };
        salaries[monthKey][field] = val;
        saveAll();
    }

    // ==========================================
    // SECCI√ìN 5: DATOS (EXPORT / IMPORT)
    // ==========================================

    function exportData() {
        const data = {
            companies: companies,
            expenses: expenses,
            salaries: salaries
        };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `datos_sistema_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function importData() {
        const file = document.getElementById('importFile').files[0];
        if(!file) return alert('Selecciona un archivo primero');
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data.companies && data.expenses) {
                    companies = data.companies;
                    expenses = data.expenses;
                    salaries = data.salaries || {}; // Compatibilidad
                    saveAll();
                    alert('¬°Datos restaurados con √©xito!');
                    location.reload();
                } else {
                    alert('El archivo no parece ser v√°lido');
                }
            } catch(err) {
                alert('Error al leer el archivo');
            }
        };
        reader.readAsText(file);
    }

    // --- UTILS COMUNES ---
    function markPaid(comp, id) {
        const date = prompt("Fecha Cobro (AAAA-MM-DD):", new Date().toISOString().split('T')[0]);
        if(!date) return;
        const entry = companies[comp].find(e => e.id === id);
        if(entry) { entry.datePay = date; saveAll(); refreshIncomeViews(); }
    }
    function delEntry(comp, id) {
        if(!confirm('¬øBorrar?')) return;
        companies[comp] = companies[comp].filter(e => e.id !== id);
        saveAll();
        refreshIncomeViews();
    }
    function switchIncomeTab(tab) {
        document.querySelectorAll('#macro-income .view-section').forEach(e => e.style.display = 'none');
        document.querySelectorAll('#macro-income .tab-btn').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+tab).style.display = 'block';
        const map = {companies:'tab1', pending:'tab2', billing:'tab3', collected:'tab4', filter:'tab5'};
        document.getElementById(map[tab]).classList.add('active');
        refreshIncomeViews();
    }
    function refreshIncomeViews() {
        if(document.getElementById('view-pending').style.display === 'block') loadPendingView();
        if(document.getElementById('view-billing').style.display === 'block') loadBillingView();
        if(document.getElementById('view-collected').style.display === 'block') loadCollectedView();
        if(document.getElementById('view-companies').style.display === 'block') renderCompanies();
        if(document.getElementById('view-filter').style.display === 'block') populateCompanyFilter();
    }

    // INIT
    const now = new Date().toISOString().slice(0, 7);
    const currentYear = new Date().getFullYear();
    document.getElementById('billingMonthSelector').value = now;
    document.getElementById('collectedMonthSelector').value = now;
    document.getElementById('expenseMonth').value = now;
    document.getElementById('salaryYear').value = currentYear;
    document.getElementById('taxYear').value = currentYear;
    document.getElementById('filterYear').value = currentYear;
    
    renderCompanies();
    window.onclick = (e) => { if(e.target == document.getElementById('companyModal')) closeModal(); }

</script>
</body>
</html>