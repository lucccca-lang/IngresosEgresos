<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Gesti√≥n</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <style>
        /* --- ESTILOS VISUALES --- */
        :root {
            /* MODO CLARO (Default) */
            --primary: #2563eb;       
            --expense-color: #be123c; 
            --salary-color: #059669;  
            --tax-color: #7c3aed;     
            --data-color: #475569;    
            --bg: #f1f5f9;
            --white: #ffffff;
            --text-main: #0f172a;
            --text-sec: #64748b;
            --border: #cbd5e1;
            --input-bg: #ffffff;
            --card-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* MODO OSCURO */
        [data-theme="dark"] {
            --primary: #3b82f6;       
            --expense-color: #f43f5e; 
            --salary-color: #10b981;  
            --tax-color: #a78bfa;     
            --data-color: #94a3b8;    
            --bg: #0f172a;            
            --white: #1e293b;         
            --text-main: #f1f5f9;     
            --text-sec: #94a3b8;      
            --border: #334155;        
            --input-bg: #334155;      
            --card-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); margin: 0; padding: 10px; color: var(--text-main); 
            -webkit-tap-highlight-color: transparent; padding-bottom: 80px; transition: background 0.3s, color 0.3s;
        }
        
        .container { max-width: 1000px; margin: 0 auto; }

        /* HEADER SUPERIOR */
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .theme-toggle { background: none; border: none; font-size: 24px; cursor: pointer; padding: 5px; border-radius: 50%; transition: 0.2s; }
        .theme-toggle:active { transform: scale(0.9); background: rgba(0,0,0,0.1); }
        [data-theme="dark"] .theme-toggle { filter: invert(1); }

        .cloud-status { font-size: 11px; font-weight: bold; color: #10b981; margin-bottom: 15px; display: flex; align-items: center; gap: 5px;}

        /* --- NAVEGACI√ìN --- */
        .main-nav {
            display: flex; gap: 5px; background: var(--white); padding: 5px;
            border-radius: 12px; box-shadow: var(--card-shadow);
            margin-bottom: 15px; position: sticky; top: 0; z-index: 100; flex-wrap: wrap;
            border: 1px solid var(--border);
        }
        .main-nav button {
            flex: 1; padding: 10px 5px; border: none; background: transparent;
            font-size: 10px; font-weight: 800; cursor: pointer;
            border-radius: 8px; color: var(--text-sec); transition: 0.2s;
            text-transform: uppercase; min-width: 60px;
        }
        .main-nav button.active-income { background: var(--primary); color: white; }
        .main-nav button.active-expense { background: var(--expense-color); color: white; }
        .main-nav button.active-salary { background: var(--salary-color); color: white; }
        .main-nav button.active-tax { background: var(--tax-color); color: white; }
        .main-nav button.active-data { background: var(--data-color); color: white; }

        /* --- SECCIONES --- */
        .macro-section { display: none; animation: fadeIn 0.3s; }
        .macro-section.active { display: block; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }

        /* --- UI COMPONENTES --- */
        .card { background: var(--white); padding: 15px; border-radius: 16px; box-shadow: var(--card-shadow); margin-bottom: 15px; border: 1px solid var(--border); transition: background 0.3s; }
        
        h3, h4, h5 { color: var(--text-main); }

        .tabs { display: flex; gap: 5px; background: var(--border); padding: 4px; border-radius: 10px; overflow-x: auto; margin-bottom: 15px; }
        .tab-btn {
            flex: 1; padding: 10px; border: none; background: transparent; cursor: pointer;
            border-radius: 8px; font-weight: 600; color: var(--text-sec); font-size: 12px; min-width: 80px; text-align: center;
        }
        .tab-btn.active { background: var(--bg); color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* INPUTS GENERICOS */
        input, select { 
            width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); 
            font-size: 16px; box-sizing: border-box; background: var(--input-bg); color: var(--text-main); margin-bottom: 8px; 
        }
        input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* INPUTS SUELDOS */
        .salary-cell-wrapper { display: flex; align-items: center; gap: 2px; }
        .salary-input { 
            flex: 1; width: 100% !important; padding: 5px !important; font-size: 13px !important; font-weight: 700 !important; 
            color: #064e3b !important; background: #ecfdf5 !important; border: 1px solid #a7f3d0 !important;
            border-radius: 5px; text-align: right; margin: 0 !important;
        }
        [data-theme="dark"] .salary-input { background: #064e3b !important; color: #ecfdf5 !important; border-color: #059669 !important; }

        /* BOTON SUMAR SUELDO */
        .btn-add-salary {
            background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; border-radius: 4px;
            width: 20px; height: 26px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 14px;
        }
        .btn-add-salary:active { background: #6ee7b7; }
        [data-theme="dark"] .btn-add-salary { background: #065f46; color: #d1fae5; border-color: #059669; }

        /* INPUTS ARCA */
        .arca-input {
            width: 100%; padding: 5px !important; font-size: 12px !important; 
            text-align: center; background: #f3f0ff !important; 
            border: 1px solid #d8b4fe !important; border-radius: 5px; margin: 0 !important;
            color: #581c87; font-weight: 600;
        }
        [data-theme="dark"] .arca-input { background: #4c1d95 !important; color: #e9d5ff !important; border-color: #7c3aed !important; }

        /* INPUTS GASTOS */
        .fix-expense-input { margin: 0 !important; text-align: right; font-weight: bold; color: #334155; font-size: 14px; transition: background 0.3s; background: rgba(255,255,255,0.6); border: 1px solid rgba(0,0,0,0.1); }
        [data-theme="dark"] .fix-expense-input { color: #0f172a; } 
        
        .expense-item-div { padding: 8px; border-radius: 8px; transition: 0.3s; position: relative; border: 1px solid var(--border); }
        
        /* BOTONES GASTO (SUMAR Y COLOR) */
        .expense-tools { display: flex; gap: 5px; }
        .btn-tool {
            background: rgba(255,255,255,0.7); color: #475569; border: 1px solid rgba(0,0,0,0.2); border-radius: 4px;
            width: 22px; height: 22px; font-size: 12px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        /* BOTONES */
        .btn-primary { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 700; width: 100%; cursor: pointer; font-size: 16px; }
        .btn-data { background: var(--data-color); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 700; width: 100%; cursor: pointer; font-size: 16px; }
        .btn-excel { background: #15803d; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 700; width: 100%; cursor: pointer; font-size: 16px; margin-bottom: 10px; }
        .btn-history { background: #8b5cf6; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 700; width: 100%; cursor: pointer; font-size: 16px; margin-bottom: 10px; }
        
        .btn-sm { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; border: none; cursor: pointer; }
        .btn-success { background: #16a34a; color: white; }
        .btn-danger { background: #fee2e2; color: #dc2626; }
        .btn-edit { background: #fef08a; color: #854d0e; border: 1px solid #fde047; }
        
        /* TOAST NOTIFICATION */
        #toast {
            visibility: hidden; min-width: 180px; background-color: #16a34a; color: #fff; 
            text-align: center; border-radius: 50px; padding: 12px 20px;
            position: fixed; z-index: 9999; left: 50%; bottom: 30px; transform: translateX(-50%);
            font-size: 14px; font-weight: 800; box-shadow: 0 4px 15px rgba(22, 163, 74, 0.4);
            display: flex; align-items: center; justify-content: center; gap: 8px;
            opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        /* LISTAS */
        .companies-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .company-btn {
            background: var(--white); border: 2px solid var(--border); color: var(--text-main);
            padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 700; text-align: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80px;
        }
        
        /* TABLAS */
        .table-wrapper { overflow-x: auto; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; min-width: 100%; color: var(--text-main); }
        th, td { padding: 8px 5px; text-align: left; border-bottom: 1px solid var(--border); font-size: 12px; vertical-align: middle; }
        th { font-size: 10px; text-transform: uppercase; color: var(--text-sec); font-weight: 700; background: var(--bg); }
        
        /* TAGS */
        .tag { font-size: 9px; padding: 2px 4px; border-radius: 4px; color: white; font-weight: bold; text-transform: uppercase; margin-right: 2px; display: inline-block; }
        .bg-mau { background: #3b82f6; } .bg-yan { background: #ec4899; } .bg-qua { background: #6366f1; } .bg-gal { background: var(--galicia); } .bg-fra { background: #334155; }
        
        /* TOTALES */
        .total-box { padding: 15px; border-radius: 12px; text-align: center; color: white; margin-bottom: 15px; }
        .bg-blue { background: var(--primary); }
        .bg-red { background: var(--expense-color); }
        .total-amount { font-size: 26px; font-weight: 800; }

        /* RESUMEN DE INGRESOS (GRID ORIGINAL) */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .summary-card { background: var(--white); padding: 10px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .summary-card h4 { margin: 0 0 10px 0; color: var(--tax-color); text-transform: uppercase; font-size: 11px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .summary-row { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; color: var(--text-sec); }
        .summary-row.total { font-weight: bold; color: var(--text-main); font-size: 13px; margin-top: 8px; border-top: 1px dashed var(--border); padding-top: 5px; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: flex-end; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: var(--white); width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; padding: 20px; max-height: 90vh; overflow-y: auto; color: var(--text-main); }
        @media(min-width: 600px) { .modal { align-items: center; } .modal-content { border-radius: 16px; width: 90%; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* LOGS TABLE */
        .log-row { border-bottom: 1px solid var(--border); padding: 8px 0; font-size: 11px; }
        .log-ts { color: var(--text-sec); font-size: 9px; margin-bottom: 2px; }
        .log-act { font-weight: bold; color: var(--primary); }
        .log-det { color: var(--text-main); }

        /* --- CLASES DE UTILIDAD PARA FECHAS EN MODAL --- */
        .date-grid-responsive { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* =========================================================
           AQU√ç EST√Å LA MAGIA RESPONSIVE (SOLO CELULAR VERTICAL)
           ========================================================= */
        @media (max-width: 600px) {
            
            /* 1. ARREGLO INGRESOS: Una tarjeta debajo de otra */
            .summary-grid { grid-template-columns: 1fr !important; }

            /* 2. ARREGLO ARCA: Inputs m√°s grandes en celular */
            .arca-input { min-width: 70px !important; font-size: 14px !important; padding: 8px !important; }

            /* 3. ARREGLO FECHAS MODAL: Side-by-side pero compactas */
            .date-grid-responsive { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
            #dateBill, #datePay { padding: 6px !important; font-size: 13px !important; }

            /* Extra: Agrandar texto resumen */
            .summary-row span { font-size: 13px; }
            .summary-row.total span { font-size: 16px; }
        }
    </style>
</head>
<body>

<div class="container">
    
    <div class="top-header">
        <div style="font-weight:bold; font-size:18px;">Sistema de Gesti√≥n</div>
        <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">üåô</button>
    </div>
    
    <div class="cloud-status" id="cloudStatus">‚è≥ Conectando a la nube...</div>

    <nav class="main-nav">
        <button id="nav-income" class="active-income" onclick="showMacroSection('income')">üè¢ Empresas</button>
        <button id="nav-expense" onclick="showMacroSection('expense')">üí∏ Gastos</button>
        <button id="nav-salary" onclick="showMacroSection('salary')">üíµ Sueldos</button>
        <button id="nav-tax" onclick="showMacroSection('tax')">üìä Ingresos</button>
        <button id="nav-data" onclick="showMacroSection('data')">üíæ Datos</button>
    </nav>

    <div id="macro-income" class="macro-section active">
        <div class="tabs">
            <button id="tab1" class="tab-btn active" onclick="switchIncomeTab('companies')">Empresas</button>
            <button id="tab2" class="tab-btn" onclick="switchIncomeTab('pending')">‚ö†Ô∏è Deudores</button>
            <button id="tab3" class="tab-btn" onclick="switchIncomeTab('billing')">üìÑ Facturado</button>
            <button id="tab4" class="tab-btn" onclick="switchIncomeTab('collected')">üí∞ Cobrado</button>
            <button id="tab5" class="tab-btn" onclick="switchIncomeTab('filter')">üîç Ficha</button>
        </div>

        <div id="view-companies" class="view-section active">
            <div class="card" style="padding:10px;">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="newCompanyName" placeholder="Nueva Empresa..." style="margin:0;">
                    <button class="btn-primary" style="width: auto;" onclick="addCompany()">+</button>
                </div>
            </div>
            <div id="companiesList" class="companies-grid"></div>
        </div>

        <div id="view-pending" class="view-section">
            <div class="total-box" style="background: #ef4444;">
                <div style="font-size:12px; opacity:0.9;">TOTAL POR COBRAR</div>
                <div class="total-amount" id="globalPendingTotal">$0</div>
            </div>
            <div id="pendingList"></div>
        </div>

        <div id="view-billing" class="view-section">
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-size:14px;">Mes Emisi√≥n:</h3>
                <input type="month" id="billingMonthSelector" onchange="loadBillingView()" style="width:auto; margin:0;">
            </div>
            <div id="billingStatusContainer"></div>
            <div id="billingResults"></div>
        </div>

        <div id="view-collected" class="view-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0; font-size:14px;">Mes Cobro:</h3>
                    <input type="month" id="collectedMonthSelector" onchange="loadCollectedView()" style="width:auto; margin:0;">
                </div>
                <div class="bank-filters">
                    <button class="bank-filter-btn active" onclick="filterBank('all', this)">VER TODO</button>
                    <button class="bank-filter-btn" onclick="filterBank('galicia', this)">GALICIA</button>
                    <button class="bank-filter-btn" onclick="filterBank('frances', this)">FRANC√âS</button>
                </div>
            </div>
            <div id="collectedResults"></div>
        </div>

        <div id="view-filter" class="view-section">
            <div class="card">
                <h3 style="margin:0 0 10px 0; font-size:14px; color:var(--text-sec);">Ficha Anual por Empresa:</h3>
                <select id="companyFilterSelect" onchange="loadCompanySpecificStats()">
                    <option value="">-- Seleccionar --</option>
                </select>
                <div style="margin-top:10px;">
                    <select id="filterYear" onchange="loadCompanySpecificStats()" style="width:auto;">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                        <option value="2028">2028</option>
                        <option value="2029">2029</option>
                        <option value="2030">2030</option>
                    </select>
                </div>
            </div>
            <div id="companyFilterResults"></div>
        </div>
    </div>

    <div id="macro-expense" class="macro-section">
        <div class="card" style="border: 1px solid var(--expense-color);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:var(--expense-color);">Gastos</h3>
                <input type="month" id="expenseMonth" onchange="loadExpensesView()" style="width:auto; margin:0;">
            </div>
            <div id="fixedExpensesGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px;"></div>
            <p style="text-align:center; font-size:11px; color:var(--text-sec); margin-top:0;">* Autom√°tico: Rojo (vac√≠o) / Verde (cargado). Manual: üé®.</p>
            <hr style="margin: 20px 0; border:0; border-top:1px dashed var(--border);">
            <div style="background:var(--bg); padding:10px; border-radius:8px; border:1px solid var(--border);">
                <h4 style="margin:0 0 10px 0; font-size:12px; color:var(--text-sec);">Gasto Extra</h4>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="extraName" placeholder="Ej: Farmacia" style="margin:0;">
                    <input type="text" inputmode="decimal" id="extraAmount" placeholder="$" style="width:80px; margin:0;" onfocus="cleanInput(this)" onblur="fmtInput(this)">
                </div>
                <button class="btn-sm" style="background:var(--data-color); color:white; width:100%; margin-top:5px;" onclick="addExtraExpense()">+ Agregar</button>
            </div>
        </div>
        <div id="expensesResults"></div>
    </div>

    <div id="macro-salary" class="macro-section">
        <div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
             <h3 style="margin:0; color:var(--salary-color)">Planilla Sueldos</h3>
             <select id="salaryYear" onchange="loadSalaryView()" style="width:auto; margin:0; font-weight:bold;">
                 <option value="2024">2024</option>
                 <option value="2025">2025</option>
                 <option value="2026">2026</option>
                 <option value="2027">2027</option>
                 <option value="2028">2028</option>
                 <option value="2029">2029</option>
                 <option value="2030">2030</option>
             </select>
        </div>
        <div class="card">
            <div class="table-wrapper">
                <table class="tax-table">
                    <thead>
                        <tr>
                            <th style="width:30px">Mes</th>
                            <th style="min-width:60px;">Sueldo</th>
                            <th style="min-width:60px;">Present.</th>
                            <th style="color:var(--salary-color)">Tot Yani</th>
                            <th style="min-width:60px; color:var(--primary);">TOT MAURO</th>
                            <th>Tot General</th>
                        </tr>
                    </thead>
                    <tbody id="salaryTableBody"></tbody>
                </table>
            </div>
        </div>
        <p style="text-align:center; font-size:11px; color:var(--text-sec);">* Mauro se calcula sumando los cobros de Empresas.</p>
    </div>

    <div id="macro-tax" class="macro-section">
        <div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
             <h3 style="margin:0; color:var(--tax-color)">Ingresos / ARCA</h3>
             <select id="taxYear" onchange="loadTaxView()" style="width:auto; margin:0; font-weight:bold;">
                 <option value="2024">2024</option>
                 <option value="2025">2025</option>
                 <option value="2026">2026</option>
                 <option value="2027">2027</option>
                 <option value="2028">2028</option>
                 <option value="2029">2029</option>
                 <option value="2030">2030</option>
             </select>
        </div>
        <div class="summary-grid">
            <div class="summary-card">
                <h4>üë§ Yanina</h4>
                <div class="summary-row"><span>1¬∞ Sem:</span> <span id="sumY1">-</span></div>
                <div class="summary-row"><span>2¬∞ Sem:</span> <span id="sumY2">-</span></div>
                <div class="summary-row total"><span>Anual:</span> <span id="sumYT">-</span></div>
            </div>
            <div class="summary-card">
                <h4>üë§ Mauro</h4>
                <div class="summary-row"><span>1¬∞ Sem:</span> <span id="sumM1">-</span></div>
                <div class="summary-row"><span>2¬∞ Sem:</span> <span id="sumM2">-</span></div>
                <div class="summary-row total"><span>Anual:</span> <span id="sumMT">-</span></div>
            </div>
            <div class="summary-card" style="border-color: #2563eb; background:var(--bg);">
                <h4 style="color:#2563eb;">üåé TOTAL GENERAL</h4>
                <div class="summary-row"><span>1¬∞ Sem:</span> <span id="sumG1" style="font-weight:bold;">-</span></div>
                <div class="summary-row"><span>2¬∞ Sem:</span> <span id="sumG2" style="font-weight:bold;">-</span></div>
                <div class="summary-row total" style="color:#2563eb; font-size:15px;"><span>ANUAL:</span> <span id="sumGT">-</span></div>
            </div>
        </div>
        <div class="card">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th style="width:30px">Mes</th>
                            <th>Fact. Yani</th>
                            <th>Fact. Mauro</th>
                            <th>TOTAL</th>
                            <th style="width:60px;">ARCA Y</th>
                            <th style="width:60px;">ARCA M</th>
                        </tr>
                    </thead>
                    <tbody id="taxTableBody"></tbody>
                </table>
            </div>
        </div>
        <p style="text-align:center; font-size:11px; color:var(--text-sec);">* Los montos son la Suma de Facturaci√≥n por Fecha de Emisi√≥n.</p>
    </div>

    <div id="macro-data" class="macro-section">
        <h3 style="color:var(--data-color); margin-bottom:10px;">Gesti√≥n de Datos</h3>
        
        <div class="card">
            <h4 style="margin-top:0;">üìú Historial de Cambios</h4>
            <p style="font-size:13px; color:var(--text-sec);">
                Ver registro de los √∫ltimos movimientos realizados en la nube.
            </p>
            <button class="btn-history" onclick="openHistoryModal()">üìú Ver Historial de Cambios</button>
        </div>

        <div class="card">
            <h4 style="margin-top:0;">üìä Exportar a Excel</h4>
            <p style="font-size:13px; color:var(--text-sec);">
                Genera un archivo .xlsx con pesta√±as organizadas con todos los datos de la nube.
            </p>
            <button class="btn-excel" onclick="exportToExcel()">üìä Descargar EXCEL</button>
        </div>

        <div class="card">
            <h4 style="margin-top:0;">üì§ Copia de Seguridad F√≠sica</h4>
            <p style="font-size:13px; color:var(--text-sec);">
                (Opcional) Descarga un archivo JSON por si quer√©s guardar un backup manual.
            </p>
            <button class="btn-data" onclick="exportData()">‚¨áÔ∏è Descargar Copia Local</button>
        </div>

        <div class="card" style="border: 1px solid #ef4444; background:var(--bg);">
            <h4 style="margin-top:0; color:#dc2626;">‚ö†Ô∏è ZONA DE PELIGRO</h4>
            <p style="font-size:13px; color:#b91c1c;">
                Esto borrar√° <b>TODA</b> la informaci√≥n de Google Cloud. No se puede deshacer.
            </p>
            <button class="btn-danger" onclick="eraseAllData()">üóëÔ∏è BORRAR TODO EL SISTEMA</button>
        </div>
    </div>

</div>

<div id="toast">üíæ Guardado en la nube</div>

<div id="companyModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 id="modalTitle" style="margin:0; color:var(--primary);">Empresa</h2>
            <button onclick="tryCloseModal()" style="background:none; border:none; font-size:24px; color:var(--text-main);">&times;</button>
        </div>
        <div class="company-actions">
            <button class="btn-action-outline" onclick="renameCompany()">‚úèÔ∏è Renombrar</button>
            <button class="btn-action-outline" onclick="deleteCompany()" style="color:#ef4444; border-color:#fecaca;">üóëÔ∏è Eliminar</button>
        </div>
        <div class="card" id="entryFormCard" style="background: var(--bg); padding:15px; border:1px solid var(--border); box-shadow:none;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="entryType">
                    <option value="fac_mauro">üë§ Fac. Mauro</option>
                    <option value="fac_yani">üë§ Fac. Yanina</option>
                    <option value="fac_quassar">üè¢ Fac. Quassar</option>
                </select>
                <select id="bankSelect">
                    <option value="galicia">üçä Galicia</option>
                    <option value="frances">üîµ Franc√©s</option>
                </select>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="invNum" placeholder="N¬∞ Factura">
                <input type="number" step="0.01" id="amount" placeholder="$ Monto">
            </div>
            <input type="text" id="entryDetail" placeholder="Detalle (Opcional)">
            
            <div class="date-grid-responsive">
                <div><label style="font-size:10px; font-weight:bold; color:var(--text-sec);">EMISI√ìN</label><input type="date" id="dateBill"></div>
                <div><label style="font-size:10px; font-weight:bold; color:var(--text-sec);">COBRO</label><input type="date" id="datePay"></div>
            </div>

            <div style="display:flex; align-items:center; gap:10px; margin-top:5px; background:rgba(255,237,213,0.5); padding:8px; border-radius:6px; border:1px solid #ffedd5;">
                <input type="checkbox" id="checkPending" onchange="toggleDateInput()" style="width:20px; margin:0;">
                <label for="checkPending" style="font-size:12px; font-weight:bold; color:#c2410c;">PENDIENTE (No cobrado)</label>
            </div>
            <div style="display:flex; gap:5px; margin-top:15px;">
                <button id="btnSaveEntry" class="btn-primary" onclick="saveCompanyEntry()">Guardar</button>
                <button id="btnCancelEdit" class="btn-sm" style="display:none; background:var(--data-color); color:white; width:auto;" onclick="cancelEditMode()">Cancelar</button>
            </div>
        </div>
        <h3>Historial</h3>
        <div class="table-wrapper">
            <table id="companyHistoryTable">
                <thead><tr><th>Detalle</th><th>Fechas</th><th>Monto</th><th></th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0; color:var(--primary);">Historial de Cambios</h2>
            <button onclick="closeHistoryModal()" style="background:none; border:none; font-size:24px; color:var(--text-main);">&times;</button>
        </div>
        <p style="font-size:12px; color:var(--text-sec);">√öltimos 50 movimientos registrados.</p>
        <div id="historyList" style="max-height:60vh; overflow-y:auto;"></div>
    </div>
</div>

<script>
    // ==========================================
    // CONFIGURACI√ìN DE FIREBASE (NUBE)
    // ==========================================
    const firebaseConfig = {
      apiKey: "AIzaSyAHaEdqsWvauWHb2lIcOCDsxaxusIpB27Q",
      authDomain: "ingresos-egresos-48366.firebaseapp.com",
      databaseURL: "https://ingresos-egresos-48366-default-rtdb.firebaseio.com",
      projectId: "ingresos-egresos-48366",
      storageBucket: "ingresos-egresos-48366.firebasestorage.app",
      messagingSenderId: "391353690272",
      appId: "1:391353690272:web:4fe8ab2f51247c99d3c1c5"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Variables globales
    let companies = {};
    let expenses = {};
    let salaries = {}; 
    let changeLogs = [];
    
    let isFirstLoad = true;
    let currentCompany = null;
    let currentBankFilter = 'all';
    let editingEntryId = null; 

    const fixedExpenseList = ["AMEX", "TARJ FRANCES", "FRANCES MASTER", "TARJ GALICIA", "TARJ ICBC", "TARJ HIPOTECARIO", "TARJ BANCO NACION", "SERV-LUZ", "GAS", "EXPENSAS", "NAFTA", "SUPERMERCADO", "MUNICIPAL", "ARBA CASA Y PATENTE", "IIGG YANINA", "IIGG MAURO", "MONOTRIBUTO", "COLEGIO LUCCA", "COLEGIO EMMA", "HONORARIOS", "TELEFONOS", "EXTRAS"];
    const expenseColors = ['rgba(255,255,255,0.8)', '#fef9c3', '#dcfce7', '#fee2e2']; 

    // ==========================================
    // SINCRONIZACI√ìN EN TIEMPO REAL
    // ==========================================
    db.ref('sistema_gestion').on('value', (snapshot) => {
        const data = snapshot.val();
        
        if (data) {
            // Ya hay datos en la nube, los descargamos
            companies = data.companies || {};
            expenses = data.expenses || {};
            salaries = data.salaries || {};
            changeLogs = data.changeLogs || [];
            document.getElementById('cloudStatus').innerHTML = "‚òÅÔ∏è Sincronizado";
        } else if (isFirstLoad) {
            // Si la nube est√° vac√≠a, migramos lo que est√© guardado en el celular
            document.getElementById('cloudStatus').innerHTML = "‚öôÔ∏è Migrando datos a la nube...";
            companies = JSON.parse(localStorage.getItem('sys_companies_v5')) || {};
            expenses = JSON.parse(localStorage.getItem('sys_expenses_v5')) || {};
            salaries = JSON.parse(localStorage.getItem('sys_salaries_v2')) || {}; 
            changeLogs = JSON.parse(localStorage.getItem('sys_logs_v1')) || [];
            
            // Subir los datos locales a Firebase para no perderlos
            saveAll(); 
        }

        if (isFirstLoad) {
            // Cosas que solo se ejecutan la primera vez que se abre la p√°gina
            isFirstLoad = false;
            initTheme();
            renderCompanies();
        } else {
            // Actualizar la pantalla si entra un cambio desde otro dispositivo
            refreshCurrentView();
        }
    });

    function saveAll() {
        // Guarda todo directamente en la Nube
        db.ref('sistema_gestion').set({
            companies,
            expenses,
            salaries,
            changeLogs
        }).then(() => {
            showToast();
        }).catch((error) => {
            alert("Error al conectar con la Nube: " + error);
        });
        
        // Mantiene una copia pasiva en el celular por las dudas
        try {
            localStorage.setItem('sys_companies_v5', JSON.stringify(companies));
            localStorage.setItem('sys_expenses_v5', JSON.stringify(expenses));
            localStorage.setItem('sys_salaries_v2', JSON.stringify(salaries));
            localStorage.setItem('sys_logs_v1', JSON.stringify(changeLogs));
        } catch(e) {}
    }

    function refreshCurrentView() {
        if(document.getElementById('macro-income').classList.contains('active')) refreshIncomeViews();
        if(document.getElementById('macro-expense').classList.contains('active')) loadExpensesView();
        if(document.getElementById('macro-salary').classList.contains('active')) loadSalaryView();
        if(document.getElementById('macro-tax').classList.contains('active')) loadTaxView();
        if(document.getElementById('historyModal').style.display === 'flex') openHistoryModal();
        if(document.getElementById('companyModal').style.display === 'flex') renderCompanyHistory();
    }

    // --- LOGGING SYSTEM ---
    function logChange(action, detail) {
        const now = new Date();
        const ts = `${now.getDate()}/${now.getMonth()+1} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
        const log = { ts, action, detail };
        changeLogs.unshift(log);
        if(changeLogs.length > 50) changeLogs.pop();
        // El guardado se hace luego al llamar saveAll() desde la funci√≥n de origen
    }

    function openHistoryModal() {
        const div = document.getElementById('historyList'); div.innerHTML = '';
        if(changeLogs.length === 0) {
            div.innerHTML = '<p style="text-align:center; color:#999;">No hay cambios registrados a√∫n.</p>';
        } else {
            changeLogs.forEach(l => {
                div.innerHTML += `
                    <div class="log-row">
                        <div class="log-ts">${l.ts}</div>
                        <div><span class="log-act">${l.action}:</span> <span class="log-det">${l.detail}</span></div>
                    </div>`;
            });
        }
        document.getElementById('historyModal').style.display = 'flex';
    }
    function closeHistoryModal() { document.getElementById('historyModal').style.display = 'none'; }


    // --- TEMAS (Dark Mode) ---
    function initTheme() {
        const saved = localStorage.getItem('sys_theme') || 'light';
        document.body.setAttribute('data-theme', saved);
        document.getElementById('themeBtn').textContent = saved === 'light' ? 'üåô' : '‚òÄÔ∏è';
    }

    function toggleTheme() {
        const current = document.body.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', next);
        localStorage.setItem('sys_theme', next);
        document.getElementById('themeBtn').textContent = next === 'light' ? 'üåô' : '‚òÄÔ∏è';
    }

    // --- EXPORTAR EXCEL (SheetJS) ---
    function exportToExcel() {
        try {
            const wb = XLSX.utils.book_new();

            // 1. DATA EMPRESAS (Flatten)
            let companiesData = [];
            Object.keys(companies).sort().forEach(comp => {
                companies[comp].forEach(e => {
                    companiesData.push({
                        Empresa: comp,
                        Tipo: e.type,
                        Banco: e.bank,
                        Factura: e.num,
                        Monto_Facturado: e.amount,
                        Fecha_Emision: e.dateBill,
                        Fecha_Cobro: e.datePay,
                        Monto_Cobrado: e.amountCollected || e.amount,
                        Detalle: e.detail || ''
                    });
                });
            });
            const wsComp = XLSX.utils.json_to_sheet(companiesData);
            XLSX.utils.book_append_sheet(wb, wsComp, "Empresas");

            // 2. DATA GASTOS
            let expData = [];
            Object.keys(expenses).sort().forEach(month => {
                expenses[month].forEach(e => {
                    expData.push({
                        Mes: month,
                        Concepto: e.name,
                        Monto: e.amount,
                        Es_Extra: !fixedExpenseList.includes(e.name) ? "SI" : "NO"
                    });
                });
            });
            const wsExp = XLSX.utils.json_to_sheet(expData);
            XLSX.utils.book_append_sheet(wb, wsExp, "Gastos");

            // 3. DATA SUELDOS
            let salData = [];
            Object.keys(salaries).sort().forEach(month => {
                const s = salaries[month];
                salData.push({
                    Mes: month,
                    Sueldo_Base: s.sueldo || 0,
                    Presentismo: s.pres || 0,
                    Total_Yani: (s.sueldo||0) + (s.pres||0),
                    AFIP_Yani: s.afip_yani || '',
                    AFIP_Mauro: s.afip_mauro || ''
                });
            });
            const wsSal = XLSX.utils.json_to_sheet(salData);
            XLSX.utils.book_append_sheet(wb, wsSal, "Sueldos");

            // 4. HISTORIAL
            const wsHist = XLSX.utils.json_to_sheet(changeLogs);
            XLSX.utils.book_append_sheet(wb, wsHist, "Historial");

            // DESCARGAR
            XLSX.writeFile(wb, "Reporte_Financiero.xlsx");
            showToast();

        } catch (error) {
            alert("Error al crear Excel: " + error);
        }
    }

    // --- UTILS ---
    const roundToTwo = (num) => Math.round((num + Number.EPSILON) * 100) / 100;
    const formatMoney = (val) => '$ ' + (val || 0).toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    const formatDate = (s) => { if(!s) return '-'; const [y,m,d]=s.split('-'); return `${d}/${m}`; };
    const getBankTag = (bank) => bank === 'galicia' ? '<span class="tag bg-gal">GAL</span>' : '<span class="tag bg-fra">FRA</span>';
    const getTypeTag = (type) => {
        if(type === 'fac_yani') return '<span class="tag bg-yan">YAN</span>';
        if(type === 'fac_quassar') return '<span class="tag bg-qua">QUA</span>';
        return '<span class="tag bg-mau">MAU</span>';
    };

    // --- TOAST ---
    function showToast() {
        const t = document.getElementById("toast");
        t.className = "show";
        setTimeout(() => { t.className = t.className.replace("show", ""); }, 2000);
    }

    // --- MANEJO DE INPUTS DINERO ---
    function cleanInput(e) {
        let v = e.value;
        v = v.replace('$', '').replace(/\./g, '').replace(',', '.').trim();
        e.value = v;
        e.type = 'number';
    }

    function fmtInput(e) {
        e.type = 'text';
        let raw = e.value;
        if(raw === '') return;
        let v = parseFloat(raw);
        if(isNaN(v)) { e.value = ''; return; }
        e.value = formatMoney(v);
    }

    // --- CALCULO AUTOMATICO PARA MAURO ---
    function getMauroCobrosForMonth(monthKey) {
        let total = 0;
        Object.values(companies).forEach(entries => {
            entries.forEach(e => {
                if (e.datePay && e.datePay.startsWith(monthKey)) {
                    total += (e.amountCollected !== undefined ? e.amountCollected : e.amount);
                }
            });
        });
        return roundToTwo(total);
    }

    // --- CALCULO FACTURACION ---
    function getBilledTotal(monthKey, allowedTypes) {
        let total = 0;
        Object.values(companies).forEach(entries => {
            entries.forEach(e => {
                if (e.dateBill && e.dateBill.startsWith(monthKey) && allowedTypes.includes(e.type)) {
                    total += e.amount;
                }
            });
        });
        return roundToTwo(total);
    }

    function showMacroSection(sec) {
        document.querySelectorAll('.macro-section').forEach(el => el.classList.remove('active'));
        document.getElementById('macro-' + sec).classList.add('active');
        document.querySelectorAll('.main-nav button').forEach(b => b.className = '');
        document.getElementById('nav-' + sec).classList.add('active-' + sec);
        if(sec === 'expense') loadExpensesView();
        if(sec === 'income') refreshIncomeViews();
        if(sec === 'salary') loadSalaryView();
        if(sec === 'tax') loadTaxView();
    }

    function addCompany() {
        const name = document.getElementById('newCompanyName').value.trim();
        if(!name) return;
        if(companies[name]) return alert('Ya existe');
        companies[name] = []; document.getElementById('newCompanyName').value = '';
        logChange("Empresa", "Creada: " + name);
        saveAll(); 
    }

    function renderCompanies() {
        const container = document.getElementById('companiesList'); container.innerHTML = '';
        Object.keys(companies).sort().forEach(name => {
            const btn = document.createElement('div'); btn.className = 'company-btn';
            const pend = companies[name].filter(e => e.datePay === "").length;
            const badge = pend > 0 ? `<div style="background:#fee2e2; color:#ef4444; font-size:10px; padding:2px 6px; border-radius:10px; margin-top:5px;">‚ö†Ô∏è ${pend} Pend</div>` : '';
            btn.innerHTML = `<span style="font-size:14px;">${name}</span> ${badge}`;
            btn.onclick = () => openCompanyModal(name); container.appendChild(btn);
        });
        populateCompanyFilter();
    }

    function openCompanyModal(name) { currentCompany = name; document.getElementById('modalTitle').textContent = name; document.getElementById('companyModal').style.display = 'flex'; cancelEditMode(); renderCompanyHistory(); }
    
    function hasUnsavedData() {
        const num = document.getElementById('invNum').value.trim();
        const amt = document.getElementById('amount').value.trim();
        const det = document.getElementById('entryDetail').value.trim();
        return (num || amt || det);
    }

    function tryCloseModal() {
        if (hasUnsavedData()) {
            if (confirm("‚ö†Ô∏è ¬øCerrar sin guardar? Se perder√°n los datos escritos.")) {
                closeModal();
            }
        } else {
            closeModal();
        }
    }

    function closeModal() { 
        document.getElementById('companyModal').style.display = 'none'; 
        currentCompany = null; 
        cancelEditMode(); 
    }

    function renameCompany() { 
        const newName = prompt("Nuevo nombre:", currentCompany); 
        if(!newName || newName === currentCompany) return; 
        if(companies[newName]) return alert("Ya existe"); 
        companies[newName] = companies[currentCompany]; 
        delete companies[currentCompany]; 
        logChange("Empresa", `Renombrada: ${currentCompany} -> ${newName}`);
        currentCompany = newName; 
        document.getElementById('modalTitle').textContent = newName; 
        saveAll();  
    }
    
    function deleteCompany() { 
        if(!confirm("¬øBorrar empresa?")) return; 
        logChange("Empresa", "Borrada: " + currentCompany);
        delete companies[currentCompany]; 
        saveAll(); closeModal(); 
    }

    function toggleDateInput() {
        const chk = document.getElementById('checkPending'), inp = document.getElementById('datePay');
        inp.disabled = chk.checked; inp.style.background = chk.checked ? 'rgba(0,0,0,0.1)' : 'var(--input-bg)';
        if(chk.checked) inp.value = ''; else if(!editingEntryId) inp.value = new Date().toISOString().split('T')[0];
    }

    function saveCompanyEntry() {
        const type = document.getElementById('entryType').value, bank = document.getElementById('bankSelect').value, num = document.getElementById('invNum').value, rawAmount = parseFloat(document.getElementById('amount').value), dBill = document.getElementById('dateBill').value, dPay = document.getElementById('checkPending').checked ? "" : document.getElementById('datePay').value, det = document.getElementById('entryDetail').value;
        if(!num || isNaN(rawAmount) || !dBill) return alert('Faltan datos');
        
        const amount = roundToTwo(rawAmount);

        let coll = undefined;
        if(editingEntryId) { const old = companies[currentCompany].find(e => e.id === editingEntryId); if(old) coll = old.amountCollected; }
        if(!dPay && !editingEntryId) coll = undefined;

        const entry = { id: editingEntryId || Date.now(), type, bank, num, amount, dateBill: dBill, datePay: dPay, detail: det, amountCollected: coll };
        
        if (editingEntryId) { 
            const idx = companies[currentCompany].findIndex(e => e.id === editingEntryId); 
            if(idx !== -1) {
                companies[currentCompany][idx] = entry; 
                logChange("Factura", `Editada en ${currentCompany} (${num})`);
            }
        } 
        else { 
            companies[currentCompany].push(entry); 
            logChange("Factura", `Agregada en ${currentCompany}: ${formatMoney(amount)}`);
        }
        saveAll(); cancelEditMode(); renderCompanyHistory();
    }

    function editEntry(id) {
        const entry = companies[currentCompany].find(e => e.id === id); if(!entry) return;
        editingEntryId = id; 
        let safeType = entry.type; if(safeType === 'factura' || safeType === 'auditoria') safeType = 'fac_mauro';
        document.getElementById('entryType').value = safeType; document.getElementById('bankSelect').value = entry.bank; document.getElementById('invNum').value = entry.num; document.getElementById('amount').value = entry.amount; document.getElementById('dateBill').value = entry.dateBill; document.getElementById('entryDetail').value = entry.detail || '';
        if(entry.datePay === "") { document.getElementById('checkPending').checked = true; document.getElementById('datePay').value = ''; } 
        else { document.getElementById('checkPending').checked = false; document.getElementById('datePay').value = entry.datePay; }
        toggleDateInput();
        document.getElementById('btnSaveEntry').textContent = "Actualizar"; document.getElementById('btnSaveEntry').style.background = "#ca8a04"; document.getElementById('entryFormCard').style.background = "#fefce8"; document.getElementById('btnCancelEdit').style.display = 'block';
    }

    function cancelEditMode() {
        editingEntryId = null; document.getElementById('invNum').value = ''; document.getElementById('amount').value = ''; document.getElementById('entryDetail').value = ''; document.getElementById('dateBill').value = new Date().toISOString().split('T')[0]; document.getElementById('datePay').value = new Date().toISOString().split('T')[0]; document.getElementById('checkPending').checked = false; toggleDateInput();
        document.getElementById('btnSaveEntry').textContent = "Guardar"; document.getElementById('btnSaveEntry').style.background = "var(--primary)"; document.getElementById('entryFormCard').style.background = "var(--bg)"; document.getElementById('btnCancelEdit').style.display = 'none';
    }

    function renderCompanyHistory() {
        if(!companies[currentCompany]) return;
        const tbody = document.querySelector('#companyHistoryTable tbody'); tbody.innerHTML = '';
        companies[currentCompany].sort((a,b) => new Date(b.dateBill) - new Date(a.dateBill)).forEach(e => {
            const isPend = e.datePay === "";
            let amDisp = `<b>${formatMoney(e.amount)}</b>`;
            if(e.amountCollected && e.amountCollected !== e.amount) amDisp += `<br><span style="font-size:10px; color:green;">Cob: ${formatMoney(e.amountCollected)}</span>`;
            const btnPay = isPend ? `<button class="btn-sm btn-success" onclick="markPaid('${currentCompany}',${e.id})">$</button>` : '';
            tbody.innerHTML += `<tr><td>${getTypeTag(e.type)} ${getBankTag(e.bank)} <b>${e.num}</b> ${e.detail ? `<span style="font-size:11px; font-style:italic; opacity:0.8; display:block;">${e.detail}</span>` : ''}</td><td>E:${formatDate(e.dateBill)}<br>C:${formatDate(e.datePay)}</td><td>${amDisp}</td><td align="right" style="white-space:nowrap;">${btnPay}<button class="btn-sm btn-edit" onclick="editEntry(${e.id})">‚úèÔ∏è</button><button class="btn-sm btn-danger" onclick="delEntry('${currentCompany}',${e.id})">√ó</button></td></tr>`;
        });
    }

    function markPaid(comp, id) {
        const e = companies[comp].find(x => x.id === id); if(!e) return;
        const date = prompt("Fecha Cobro:", new Date().toISOString().split('T')[0]); if(!date) return;
        const raw = prompt("Monto Real:", e.amount); if(raw === null) return;
        e.datePay = date; e.amountCollected = roundToTwo(parseFloat(raw)); 
        logChange("Cobro", `${comp} (${e.num}): ${formatMoney(e.amountCollected)}`);
        saveAll(); 
    }

    function delEntry(comp, id) { 
        if(!confirm('¬øBorrar?')) return; 
        companies[comp] = companies[comp].filter(e => e.id !== id); 
        logChange("Factura", `Eliminada en ${comp}`);
        saveAll(); 
    }
    
    function switchIncomeTab(tab) {
        document.querySelectorAll('#macro-income .view-section').forEach(e => e.style.display = 'none'); document.querySelectorAll('#macro-income .tab-btn').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+tab).style.display = 'block';
        const map = {companies:'tab1', pending:'tab2', billing:'tab3', collected:'tab4', filter:'tab5'}; document.getElementById(map[tab]).classList.add('active'); refreshIncomeViews();
    }
    function refreshIncomeViews() {
        if(document.getElementById('view-pending').style.display === 'block') loadPendingView();
        if(document.getElementById('view-billing').style.display === 'block') loadBillingView();
        if(document.getElementById('view-collected').style.display === 'block') loadCollectedView();
        if(document.getElementById('view-companies').style.display === 'block') renderCompanies();
        if(document.getElementById('view-filter').style.display === 'block') populateCompanyFilter();
    }
    function loadPendingView() {
        const div = document.getElementById('pendingList'); div.innerHTML = ''; let total = 0;
        Object.keys(companies).forEach(name => {
            const list = companies[name].filter(e => e.datePay === "");
            if(list.length > 0) {
                const sub = list.reduce((s,e)=>s+e.amount,0); total += sub;
                div.innerHTML += `<div class="card"><h4>${name} <span style="float:right; color:#dc2626">${formatMoney(sub)}</span></h4><table>${list.map(e=>`<tr><td>${getTypeTag(e.type)} ${getBankTag(e.bank)} <b>${e.num}</b></td><td>${formatDate(e.dateBill)}</td><td>${formatMoney(e.amount)}</td><td align="right"><button class="btn-sm btn-success" onclick="markPaid('${name}',${e.id})">Cobrar</button></td></tr>`).join('')}</table></div>`;
            }
        });
        document.getElementById('globalPendingTotal').innerText = formatMoney(total);
    }
    function loadBillingView() {
        const m = document.getElementById('billingMonthSelector').value; const div = document.getElementById('billingResults'); const st = document.getElementById('billingStatusContainer'); div.innerHTML = ''; st.innerHTML = ''; if(!m) return;
        let tot = 0, pend = 0;
        Object.keys(companies).forEach(n => {
            const list = companies[n].filter(e => e.dateBill.startsWith(m));
            if(list.length > 0) {
                let sub = list.reduce((s,e)=>s+e.amount,0); tot += sub;
                div.innerHTML += `<div class="card"><h4>${n}</h4><table>${list.map(e=>{ if(!e.datePay) pend+=e.amount; return `<tr><td>${getTypeTag(e.type)} ${getBankTag(e.bank)} <b>${e.num}</b></td><td>${e.datePay?'‚úî':'‚è≥'}</td><td align="right"><b>${formatMoney(e.amount)}</b></td></tr>`; }).join('')}</table></div>`;
            }
        });
        if(tot > 0) {
            st.innerHTML = (pend === 0) ? `<div style="background:#dcfce7; color:#166534; padding:15px; border-radius:12px; text-align:center; font-weight:bold; margin-bottom:15px; border:2px solid #bbf7d0;">‚ú® ¬°FELICITACIONES! ‚ú®<br>Todo cobrado.</div>` : `<div style="background:#fee2e2; color:#dc2626; padding:15px; border-radius:12px; text-align:center; font-weight:bold; margin-bottom:15px; border:2px solid #fecaca;">‚ö†Ô∏è FALTA COBRAR: ${formatMoney(pend)}</div>`;
            div.insertAdjacentHTML('afterbegin', `<div class="total-box bg-blue"><div style="font-size:12px;">TOTAL FACTURADO</div><div class="total-amount">${formatMoney(tot)}</div></div>`);
        } else { div.innerHTML = '<p style="text-align:center; padding:20px;">Sin facturaci√≥n.</p>'; }
    }
    function loadCollectedView() {
        const m = document.getElementById('collectedMonthSelector').value; const div = document.getElementById('collectedResults'); div.innerHTML = ''; if(!m) return;
        let tot = 0;
        Object.keys(companies).forEach(n => {
            const list = companies[n].filter(e => e.datePay && e.datePay.startsWith(m) && (currentBankFilter === 'all' || e.bank === currentBankFilter));
            if(list.length > 0) {
                let sub = list.reduce((s,e)=>s+(e.amountCollected!==undefined?e.amountCollected:e.amount),0); tot += sub;
                div.innerHTML += `<div class="card"><h4>${n}</h4><table>${list.map(e=>`<tr><td>${getTypeTag(e.type)} ${getBankTag(e.bank)} <b>${e.num}</b></td><td>${formatDate(e.datePay)}</td><td align="right"><b>${formatMoney(e.amountCollected||e.amount)}</b></td></tr>`).join('')}</table></div>`;
            }
        });
        if(tot > 0) div.insertAdjacentHTML('afterbegin', `<div class="total-box" style="background:#16a34a"><div style="font-size:12px;">TOTAL COBRADO</div><div class="total-amount">${formatMoney(tot)}</div></div>`);
        else div.innerHTML = '<p style="text-align:center; padding:20px;">Sin cobros.</p>';
    }
    function filterBank(f, b) { currentBankFilter = f; document.querySelectorAll('.bank-filter-btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); loadCollectedView(); }
    function populateCompanyFilter() { const s = document.getElementById('companyFilterSelect'); s.innerHTML = '<option value="">-- Elige una empresa --</option>'; Object.keys(companies).sort().forEach(c => s.innerHTML += `<option value="${c}">${c}</option>`); }
    function loadCompanySpecificStats() {
        const c = document.getElementById('companyFilterSelect').value, y = document.getElementById('filterYear').value, div = document.getElementById('companyFilterResults'); div.innerHTML = ''; if(!c) return;
        let h = '<div class="card"><table style="font-size:12px;"><thead><tr><th>Mes</th><th>Facturado</th><th>Cobrado</th></tr></thead><tbody>', tF=0, tC=0;
        for(let i=1; i<=12; i++) {
            const m = `${y}-${i.toString().padStart(2, '0')}`;
            const sF = companies[c].filter(e => e.dateBill.startsWith(m)).reduce((s,e)=>s+e.amount,0);
            const sC = companies[c].filter(e => e.datePay && e.datePay.startsWith(m)).reduce((s,e)=>s+(e.amountCollected||e.amount),0);
            tF += sF; tC += sC; if(sF > 0 || sC > 0) h += `<tr><td><b>${i.toString().padStart(2,'0')}</b></td><td style="color:#2563eb">${formatMoney(sF)}</td><td style="color:#16a34a; font-weight:bold;">${formatMoney(sC)}</td></tr>`;
        }
        div.innerHTML = h + `<tr><td><b>TOT</b></td><td><b>${formatMoney(tF)}</b></td><td><b>${formatMoney(tC)}</b></td></tr></tbody></table></div>`;
    }

    // ==========================================
    // SECCI√ìN 2: GASTOS (LOGICA COLOR AUTO/MANUAL)
    // ==========================================
    function loadExpensesView() {
        const m = document.getElementById('expenseMonth').value, grid = document.getElementById('fixedExpensesGrid'); if(!expenses[m]) expenses[m] = []; grid.innerHTML = '';
        fixedExpenseList.forEach(name => {
            const e = expenses[m].find(x => x.name === name), val = e ? e.amount : '', userColor = (e && e.color) ? e.color : null;
            
            let bg;
            if (userColor !== null && userColor !== undefined) {
                // COLOR MANUAL FIJO
                bg = expenseColors[userColor];
            } else {
                // COLOR AUTOMATICO: Rojo si vac√≠o, Verde si tiene monto
                bg = (val > 0) ? expenseColors[2] : expenseColors[3];
            }

            const fmtVal = val ? formatMoney(val) : '';
            grid.innerHTML += `
                <div class="expense-item-div" style="background:${bg}">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:3px;">
                        <label style="font-size:10px; font-weight:700; color:#475569;">${name}</label>
                        <div class="expense-tools">
                           <button class="btn-tool" onclick="cycleExpenseColor('${name}')">üé®</button>
                           <button class="btn-tool" onclick="addToExpense('${name}')">+</button>
                        </div>
                    </div>
                    <input type="text" inputmode="decimal" class="fix-expense-input" id="fix_${name.replace(/\s/g,'')}" placeholder="0" value="${fmtVal}" onfocus="cleanInput(this)" onblur="fmtInput(this); autoSaveFixed('${name}')">
                </div>`;
        });
        updateExpenseTotalDisplay();
    }
    
    function autoSaveFixed(n) { 
        const m = document.getElementById('expenseMonth').value;
        const input = document.getElementById("fix_"+n.replace(/\s/g,''));
        let raw = input.value;
        if(raw.includes('$')) raw = raw.replace('$', '').replace(/\./g, '').replace(',', '.').trim();
        const v = parseFloat(raw);
        let list = expenses[m], idx = list.findIndex(x=>x.name===n); 
        
        let oldVal = (idx >= 0) ? list[idx].amount : 0;

        if(!isNaN(v) && v > 0) { 
            const cleanV = roundToTwo(v);
            if(idx>=0) {
                if(list[idx].amount !== cleanV) {
                    list[idx].amount=cleanV;
                    logChange("Gasto", `${n}: ${formatMoney(oldVal)} -> ${formatMoney(cleanV)}`);
                }
            } else {
                list.push({id:Date.now(), name:n, amount:cleanV});
                logChange("Gasto", `${n}: ${formatMoney(cleanV)}`);
            }
        } else if(idx>=0) {
            // SI BORRA EL MONTO:
            if(list[idx].color !== undefined) {
                if(list[idx].amount !== 0) logChange("Gasto", `${n}: ${formatMoney(oldVal)} -> $0`);
                list[idx].amount = 0;
            } else {
                if(list[idx].amount !== 0) logChange("Gasto", `${n}: ${formatMoney(oldVal)} -> Borrado`);
                list.splice(idx,1); 
            }
        }
        saveAll(); 
    }

    function addToExpense(n) {
        const m = document.getElementById('expenseMonth').value; 
        const e = expenses[m]?.find(x => x.name === n);
        const currentVal = e ? e.amount : 0;
        const addVal = prompt(`Monto a sumar a ${n} (Actual: ${formatMoney(currentVal)}):`);
        if(addVal && addVal.trim() !== "") {
            let cleanAdd = addVal.replace(',', '.');
            if(!isNaN(parseFloat(cleanAdd))) {
                const added = roundToTwo(parseFloat(cleanAdd));
                const newVal = roundToTwo(currentVal + added);
                if(!expenses[m]) expenses[m] = [];
                const idx = expenses[m].findIndex(x => x.name === n);
                if(idx >= 0) expenses[m][idx].amount = newVal; else expenses[m].push({id:Date.now(), name:n, amount:newVal});
                
                logChange("Gasto Suma", `${n}: Sumado ${formatMoney(added)}`);
                saveAll(); 
            }
        }
    }

    function cycleExpenseColor(n) {
        const m = document.getElementById('expenseMonth').value; 
        if(!expenses[m]) expenses[m] = [];
        let idx = expenses[m].findIndex(x => x.name === n);
        
        if(idx === -1) {
            expenses[m].push({id:Date.now(), name:n, amount:0, color:0});
            idx = expenses[m].length - 1;
        } else {
            if(expenses[m][idx].color === undefined) expenses[m][idx].color = 0;
        }

        const curColor = expenses[m][idx].color;
        const nextColor = (curColor + 1);
        
        if(nextColor >= expenseColors.length) {
            delete expenses[m][idx].color;
            if(expenses[m][idx].amount === 0) expenses[m].splice(idx,1);
        } else {
            expenses[m][idx].color = nextColor;
        }
        
        saveAll(); 
    }

    function updateExpenseTotalDisplay() {
        const m = document.getElementById('expenseMonth').value;
        const currentYear = m.split('-')[0];
        const list = expenses[m] || [];
        const totMonth = list.reduce((s,e)=>s+e.amount,0);
        let totYear = 0;
        Object.keys(expenses).forEach(key => {
            if(key.startsWith(currentYear)) {
                totYear += expenses[key].reduce((s,e)=>s+e.amount,0);
            }
        });

        const extras = list.filter(e => !fixedExpenseList.includes(e.name));
        
        document.getElementById('expensesResults').innerHTML = `
            <div class="total-box bg-red" style="margin-top:20px; display:flex; justify-content:space-around; align-items:center;">
               <div style="text-align:center;">
                   <div style="font-size:11px; opacity:0.8;">TOTAL MES</div>
                   <div style="font-size:22px; font-weight:800;">${formatMoney(totMonth)}</div>
               </div>
               <div style="width:1px; height:40px; background:rgba(255,255,255,0.3);"></div>
               <div style="text-align:center;">
                   <div style="font-size:11px; opacity:0.8;">TOTAL A√ëO ${currentYear}</div>
                   <div style="font-size:22px; font-weight:800;">${formatMoney(totYear)}</div>
               </div>
            </div>` 
            + (extras.length ? `<div class="card" style="margin-top:10px;"><h5>Extras</h5><table>${extras.map(e=>`<tr><td>${e.name}</td><td align="right"><b>${formatMoney(e.amount)}</b></td><td><button class="btn-sm btn-danger" onclick="delExpense('${m}',${e.id})">√ó</button></td></tr>`).join('')}</table></div>` : '');
    }
    
    function addExtraExpense() { 
        const m = document.getElementById('expenseMonth').value, n = document.getElementById('extraName').value;
        let rawA = document.getElementById('extraAmount').value;
        if(rawA.includes('$')) rawA = rawA.replace('$', '').replace(/\./g, '').replace(',', '.').trim();
        const a = parseFloat(rawA); 
        if(!n || isNaN(a)) return; 
        if(!expenses[m]) expenses[m]=[]; 
        const cleanA = roundToTwo(a);
        expenses[m].push({id:Date.now(), name:n, amount:cleanA}); 
        logChange("Extra", `Agregado: ${n} (${formatMoney(cleanA)})`);
        document.getElementById('extraName').value=''; 
        document.getElementById('extraAmount').value=''; 
        saveAll(); 
    }
    
    function delExpense(m, id) { 
        if(confirm('¬øBorrar?')) { 
            const e = expenses[m].find(x=>x.id===id);
            if(e) logChange("Extra", `Borrado: ${e.name}`);
            expenses[m] = expenses[m].filter(e=>e.id!==id); 
            saveAll(); 
        } 
    }

    // ==========================================
    // SECCI√ìN 3: SUELDOS (Calculo Auto + Boton Sumar)
    // ==========================================
    function loadSalaryView() {
        const y = document.getElementById('salaryYear').value, tbody = document.getElementById('salaryTableBody'); tbody.innerHTML = '';
        for(let i=1; i<=12; i++) {
            const mKey = `${y}-${i.toString().padStart(2, '0')}`;
            const d = salaries[mKey] || { sueldo:0, pres:0 };
            const mauro = getMauroCobrosForMonth(mKey);
            const yani = roundToTwo((d.sueldo||0) + (d.pres||0));
            tbody.innerHTML += `
            <tr>
                <td><b>${i.toString().padStart(2,'0')}</b></td>
                <td>
                    <div class="salary-cell-wrapper">
                        <input type="number" step="0.01" class="salary-input" value="${d.sueldo||''}" onchange="saveSal('${mKey}','sueldo',this.value)">
                        <button class="btn-add-salary" onclick="addToSalary('${mKey}','sueldo')">+</button>
                    </div>
                </td>
                <td>
                    <div class="salary-cell-wrapper">
                        <input type="number" step="0.01" class="salary-input" value="${d.pres||''}" onchange="saveSal('${mKey}','pres',this.value)">
                        <button class="btn-add-salary" onclick="addToSalary('${mKey}','pres')">+</button>
                    </div>
                </td>
                <td style="font-weight:bold; color:var(--salary-color);">${formatMoney(yani)}</td>
                <td style="font-weight:bold; color:var(--primary);">${formatMoney(mauro)}</td>
                <td><b>${formatMoney(yani+mauro)}</b></td>
            </tr>`;
        }
    }
    function saveSal(m, f, v) { 
        if(!salaries[m]) salaries[m]={sueldo:0,pres:0}; 
        const old = salaries[m][f] || 0;
        const val = roundToTwo(parseFloat(v)||0);
        if(old !== val) {
            salaries[m][f]=val; 
            logChange("Sueldo", `Mes ${m} (${f}): ${formatMoney(val)}`);
            saveAll(); 
        }
    }

    function addToSalary(mKey, field) {
        if(!salaries[mKey]) salaries[mKey] = { sueldo:0, pres:0 };
        const currentVal = salaries[mKey][field] || 0;
        const addVal = prompt(`Monto a sumar (Actual: ${formatMoney(currentVal)}):`);
        if (addVal && addVal.trim() !== "") {
            let cleanAdd = addVal.replace(',', '.');
            if(!isNaN(parseFloat(cleanAdd))) {
                const added = roundToTwo(parseFloat(cleanAdd));
                const newVal = roundToTwo(currentVal + added);
                saveSal(mKey, field, newVal);
            }
        }
    }

    // ==========================================
    // SECCI√ìN 4: INGRESOS (ARCA MEJORADO)
    // ==========================================
    function loadTaxView() {
        const y = document.getElementById('taxYear').value, tbody = document.getElementById('taxTableBody'); tbody.innerHTML = '';
        let sy1=0, sy2=0, sm1=0, sm2=0;
        for(let i=1; i<=12; i++) {
            const mKey = `${y}-${i.toString().padStart(2, '0')}`;
            const d = salaries[mKey] || { sueldo:0, pres:0, afip_yani:'', afip_mauro:'' };
            const yVal = getBilledTotal(mKey, ['fac_yani']);
            const mVal = getBilledTotal(mKey, ['fac_mauro', 'fac_quassar']);
            if(i<=6) { sy1+=yVal; sm1+=mVal; } else { sy2+=yVal; sm2+=mVal; }
            tbody.innerHTML += `<tr><td><b>${i}</b></td><td>${formatMoney(yVal)}</td><td>${formatMoney(mVal)}</td><td style="color:#2563eb"><b>${formatMoney(yVal+mVal)}</b></td><td><input type="text" class="arca-input" value="${d.afip_yani||''}" onchange="saveAfip('${mKey}','afip_yani',this.value)"></td><td><input type="text" class="arca-input" value="${d.afip_mauro||''}" onchange="saveAfip('${mKey}','afip_mauro',this.value)"></td></tr>`;
        }
        document.getElementById('sumY1').innerText = formatMoney(sy1); document.getElementById('sumY2').innerText = formatMoney(sy2); document.getElementById('sumYT').innerText = formatMoney(sy1+sy2);
        document.getElementById('sumM1').innerText = formatMoney(sm1); document.getElementById('sumM2').innerText = formatMoney(sm2); document.getElementById('sumMT').innerText = formatMoney(sm1+sm2);
        document.getElementById('sumG1').innerText = formatMoney(sy1+sm1); document.getElementById('sumG2').innerText = formatMoney(sy2+sm2); document.getElementById('sumGT').innerText = formatMoney(sy1+sm1+sy2+sm2);
    }
    function saveAfip(m, f, v) { 
        if(!salaries[m]) salaries[m]={sueldo:0,pres:0}; 
        salaries[m][f]=v; 
        saveAll(); 
    }

    function exportData() { const b = new Blob([JSON.stringify({companies,expenses,salaries,changeLogs})], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'backup.json'; a.click(); }
    
    // Restaurar copia ahora sube directamente a Firebase
    function importData() { 
        const f = document.getElementById('importFile').files[0]; 
        const r = new FileReader(); 
        r.onload = (e) => { 
            const d = JSON.parse(e.target.result); 
            companies=d.companies || {}; 
            expenses=d.expenses || {}; 
            salaries=d.salaries || {}; 
            changeLogs=d.changeLogs||[]; 
            saveAll(); 
            alert("Datos restaurados a la nube con √©xito.");
        }; 
        r.readAsText(f); 
    }
    
    // --- BORRAR TODO ---
    function eraseAllData() {
        if(confirm("‚õî ¬°ATENCI√ìN! ‚õî\n\n¬øEst√°s seguro de que quer√©s BORRAR TODO DE LA NUBE?\n\nSe perder√°n todas las empresas, gastos y sueldos de todos los dispositivos conectados.")) {
            if(confirm("¬øDe verdad? Esta es la √∫ltima oportunidad para cancelar.")) {
                companies = {}; expenses = {}; salaries = {}; changeLogs = [];
                saveAll();
                localStorage.clear();
                alert("Sistema reiniciado a cero.");
            }
        }
    }

    // --- AUTO FECHAS AL DIA Y TEMA ---
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.toISOString().slice(0, 7);

    // Setear Fechas
    document.getElementById('billingMonthSelector').value = currentMonth;
    document.getElementById('collectedMonthSelector').value = currentMonth;
    document.getElementById('expenseMonth').value = currentMonth;
    document.getElementById('salaryYear').value = currentYear;
    document.getElementById('taxYear').value = currentYear;
    document.getElementById('filterYear').value = currentYear;

    window.onclick = (e) => { 
        if (e.target == document.getElementById('companyModal')) tryCloseModal();
        if (e.target == document.getElementById('historyModal')) closeHistoryModal();
    }
</script>
</body>
</html>